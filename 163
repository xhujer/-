/**
 * Loon ËÑöÊú¨ÔºöÁΩëÊòìÈÇÆÁÆ±Á©∫Èó¥Â•ñÂä±Ëá™Âä®Âåñ
 * - ÈÄÇÈÖç dashi.163.com Êé•Âè£
 * - Ê®°ÊãüÁúüÂÆûËßÇÁúãÊó∂ÈïøÂª∂Ëøü
 * - Ëá™Âä®ÊèêÂèñ UID Âíå AdsID
 */

const $ = new Env("ÁΩëÊòìÁ©∫Èó¥Âä©Êâã");

// ====== 1) ÂüüÂêçÁôΩÂêçÂçï ======
const ALLOWED_HOSTS = ["dashi.163.com"];
const API_BASE = "https://dashi.163.com";
const ENDPOINT_FULFILL = "/api/video-award/fulfill"; 

// ====== 2) ËøêË°åÂèÇÊï∞ ======
const CFG = {
  debug: true,
  timeoutMs: 10000,
  maxRetries: 2,
  baseBackoffMs: 1000,
  // Ê®°ÊãüÁúüÂÆûÊÑüÔºöÂª∂Ëøü 32-35 ÁßíÔºàËßÜÈ¢ëÈÄöÂ∏∏‰∏∫ 30sÔºâ
  delayMs: 32000 + Math.floor(Math.random() * 3000), 
};

// ====== 3) ‰∏ªÈÄªËæëÔºöÁõëÂê¨ info Êé•Âè£Ëé∑Âèñ‰ªªÂä°ÂèÇÊï∞ ======
if ($request?.url?.includes("/api/video-award/info")) {
  const host = getHost($request.url);
  if (!ALLOWED_HOSTS.includes(host)) return $done({});

  const res = safeJson($response?.body);
  if (!res || res.success !== "true") {
    $.log("Info Êé•Âè£ËøîÂõûÂºÇÂ∏∏ÊàñÊú™ÁôªÂΩï");
    return $done({});
  }

  // ÊèêÂèñ 163 ÁâπÊúâÁöÑ params Â≠óÊÆµ
  const params = res.result?.params;
  if (!params) return $done({});

  // Ê†°È™åÊ¨°Êï∞Ôºö‰ªäÊó•Ââ©‰ΩôÊ¨°Êï∞ > 0 ÊâçËß¶Âèë
  const remaining = Number(params.dailyRemainingCnt ?? 0);
  if (remaining <= 0) {
    $.log(`‰ªäÊó•Â∑≤Ëææ‰∏äÈôê (${params.dailyObtainedCnt}/8)ÔºåË∑≥ËøáÊâßË°å`);
    return $done({});
  }

  // ÂπÇÁ≠âÈîÆÔºöÁî± UID + AdsID + ÂΩìÂâçÈ¢ÜÂ•ñÊ¨°Êï∞ ÁªÑÊàê
  // Á°Æ‰øùÂú®ÊâãÂä®Âà∑Êñ∞È°µÈù¢Êó∂Ôºå‰∏ç‰ºöÂØπÂêå‰∏ÄÊ¨°Â•ñÂä±ÂèëÈÄÅÈáçÂ§çËØ∑Ê±Ç
  const idempotencyKey = makeIdempotencyKey({
    uid: params.uid,
    adsId: params.adsId,
    obtained: params.dailyObtainedCnt
  });

  // ÊûÑÈÄ† 163 ÁªìÁÆóÊé•Âè£ÈúÄË¶ÅÁöÑ Payload
  const payload = {
    "adsId": params.adsId,
    "strategyId": params.strategyId,
    "sceneId": params.sceneId,
    "uid": params.uid,
    "utype": params.utype,
    "positionId": params.positionId || "mailListAccount"
  };

  $.notify("Ê£ÄÊµãÂà∞Â•ñÂä±‰ªªÂä°", "", `Ââ©‰Ωô ${remaining} Ê¨°ÔºåÂ∞ÜÂú® ${Math.round(CFG.delayMs/1000)}s ÂêéÂ∞ùËØïÈ¢ÜÂèñ`);

  // ÂºÇÊ≠•Ëß¶ÂèëÁªìÁÆó
  setTimeout(() => {
    fulfill(payload, idempotencyKey, $request.headers);
  }, CFG.delayMs);
}

$done({});

// ====== 4) fulfill ËØ∑Ê±ÇÔºöÊâßË°åÁªìÁÆó ======
function fulfill(payload, idempotencyKey, originalHeaders) {
  const url = API_BASE + ENDPOINT_FULFILL;

  const headers = {
    "Content-Type": "application/json",
    "User-Agent": originalHeaders["User-Agent"] || originalHeaders["user-agent"],
    "Cookie": originalHeaders["Cookie"] || originalHeaders["cookie"],
    "Referer": "https://dashi.163.com/projects/video-award/index.html",
    "X-Idempotency-Key": idempotencyKey, // È™®Êû∂‰øùÁïôÂ≠óÊÆµ
  };

  requestWithRetry({
    method: "POST",
    url,
    headers,
    body: JSON.stringify(payload),
    timeoutMs: CFG.timeoutMs,
  }, CFG.maxRetries)
  .then((data) => {
    const res = safeJson(data);
    if (res && res.success === "true") {
      $.notify("È¢ÜÂèñÊàêÂäü üéÅ", "", `Ëé∑Âæó ${payload.unit || '18'}M Á©∫Èó¥`);
    } else {
      $.notify("È¢ÜÂèñÂ§±Ë¥•", "", res?.marketText || "Êé•Âè£ÈÄªËæëÊú™ÈÄöËøá");
    }
  })
  .catch((e) => $.log(`ËØ∑Ê±ÇÂºÇÂ∏∏: ${e}`))
  .finally(() => $.log("Fulfill ÊµÅÁ®ãÁªìÊùü"));
}

// ====== 5) Ê†∏ÂøÉÂáΩÊï∞Â∞ÅË£ÖÔºàÊ≤øÁî®‰Ω†ÁöÑ Env È™®Êû∂Ôºâ ======
function requestWithRetry(req, retriesLeft) {
  return new Promise((resolve, reject) => {
    const runOnce = (attempt) => {
      const opt = { url: req.url, headers: req.headers, body: req.body, timeout: req.timeoutMs };
      $httpClient.post(opt, (err, resp, data) => {
        if (!err && resp.status < 400) return resolve(data);
        if (retriesLeft - attempt <= 0) return reject(err || `HTTP ${resp.status}`);
        setTimeout(() => runOnce(attempt + 1), CFG.baseBackoffMs * Math.pow(2, attempt));
      });
    };
    runOnce(0);
  });
}

function safeJson(s) { try { return JSON.parse(s); } catch { return null; } }
function getHost(url) { return url.match(/^https?:\/\/([^\/]+)/i)?.[1] || ""; }
function makeIdempotencyKey(obj) {
  const raw = JSON.stringify(obj);
  let h = 2166136261;
  for (let i = 0; i < raw.length; i++) { h ^= raw.charCodeAt(i); h = Math.imul(h, 16777619); }
  return "163_" + (h >>> 0).toString(16);
}

function Env(name) {
  return {
    name,
    log: (...a) => CFG.debug && console.log(`[${name}]`, ...a),
    notify: (t, s, c) => $notification.post(t, s, c)
  };
}
