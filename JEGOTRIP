#!name=无忧行去广告
#!desc=移除开屏广告、屏蔽首页推荐、活动推广及指定模块（推荐、周边、玩转大湾区、全球景点、香港新鲜事）
#!tag=去广告
#!icon=https://imgtolinkx.com/i/CO0eIFoS
#!openUrl=https://apps.apple.com/app/id1037589370
#!bundleId=com.cmi.jegotrip
#!date=2025-08-29

[Rule]
# 屏蔽广告接口和推荐
DOMAIN,app3.jegotrip.com.cn,REJECT
# 屏蔽推送和广告资源
DOMAIN,push.it.10086.cn,REJECT
DOMAIN,oss.jegotrip.com.cn,REJECT

[Rewrite]
# --- 首页广告/推荐/推广 ---
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/(banner|getDestBanners) reject-dict
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/layout\/v1\/init\/destinationModel reject-dict
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/(rec|recommend) reject-dict
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/rec\/(columnListByRegion|queryData|sceneQuery) reject-dict

# --- 活动/专题/策略推广 ---
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/(queryGlobalStrategyData|activity|promotion|topic|strategy) reject-dict

# --- 目的地/POI 推荐广告 ---
^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/poi\/(queryJegoListAndNameByDestinationId|queryRecommendList|queryAdsPoiList) reject-dict

# --- 广告资源 ---
^https?:\/\/oss\.jegotrip\.com\.cn\/appSyncimage reject
^https?:\/\/oss\.jegotrip\.com\.cn\/img\/ reject

# --- 推送/埋点 ---
^https?:\/\/push\.it\.10086\.cn\/mc\/receipt\/iosBadge reject
^https?:\/\/umeng\.com reject
^https?:\/\/bugly\.qq\.com reject

[Script]
// 劫持首页 & 我的页面接口，删除广告和指定模块
http-response ^https?:\/\/app3\.jegotrip\.com\.cn\/api\/destination\/v1\/destination\/getDestinationById script-body=true,requires-body=true,tag=无忧行去广告
http-response ^https?:\/\/app3\.jegotrip\.com\.cn\/api\/layout\/v1\/init\/destinationModel script-body=true,requires-body=true,tag=无忧行去广告

[MitM]
hostname=app3.jegotrip.com.cn,push.it.10086.cn,oss.jegotrip.com.cn,umeng.com,bugly.qq.com

// -------- 内置 JS 脚本内容 --------
let body;
try {
    body = JSON.parse($response.body);
} catch(e) {
    $done({});
}

// ----------------- 首页 -----------------
if (body && body.data) {
    delete body.data.bannerList;
    delete body.data.recommend;
    delete body.data.columnListByRegion;
    delete body.data.poiList;
    delete body.data.promotionList;
    delete body.data.strategyList;

    if (body.data.modules) {
        const removeModules = ["推荐", "周边", "玩转大湾区", "全球景点", "香港新鲜事"];
        body.data.modules = removeModulesRecursively(body.data.modules, removeModules);
    }

    // 处理 layout 或 tabs 中的模块（如果存在）
    if (body.data.layout && Array.isArray(body.data.layout.modules)) {
        const removeModules = ["推荐", "周边", "玩转大湾区", "全球景点", "香港新鲜事"];
        body.data.layout.modules = removeModulesRecursively(body.data.layout.modules, removeModules);
    }
}

// ----------------- 我的页面 -----------------
if (body && body.data && body.data.userCenter) {
    delete body.data.userCenter.ads;
    delete body.data.userCenter.bannerList;

    if (body.data.userCenter.modules) {
        const removeModules = ["推荐", "周边", "玩转大湾区", "全球景点", "香港新鲜事"];
        body.data.userCenter.modules = removeModulesRecursively(body.data.userCenter.modules, removeModules);
    }
}

// 输出修改后的响应
$done({ body: JSON.stringify(body) });

// ----------------- 辅助函数 -----------------
function removeModulesRecursively(container, removeList) {
    if (!container || !Array.isArray(container)) return [];
    return container.filter(module => {
        // 删除 title 或 name 在 removeList 中的模块
        if (removeList.includes(module.title) || removeList.includes(module.name)) return false;
        // 递归处理子模块
        if (module.modules) {
            module.modules = removeModulesRecursively(module.modules, removeList);
        }
        return true;
    });
}
