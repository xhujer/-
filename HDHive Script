/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (v14.0 å…¨èƒ½é€šçŸ¥ç‰ˆ)
 * åŠŸèƒ½ï¼šç­¾åˆ°åŽæå– 7 é¡¹æ ¸å¿ƒæ•°æ®ï¼Œä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·è¦æ±‚çš„æ ¼å¼æŽ¨é€é€šçŸ¥
 */

const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v14'; // å‡çº§ Key ä»¥éš”ç¦»æ—§æ•°æ®
const KEY_REFERER = 'hdhive_referer_v14'; 
const KEY_UA = 'hdhive_ua_v14';
const DOMAIN = 'hdhive.com';

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await main();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘
// ------------------------------------------
async function capture() {
    if ($request.url.indexOf("user/checkin") > -1) return;
    if ($request.url.indexOf(DOMAIN) === -1) return;

    const h = $request.headers;
    const cookie = getHeader(h, 'Cookie');
    const ua = getHeader(h, 'User-Agent');
    const referer = getHeader(h, 'Referer');

    if (cookie && cookie.indexOf("token=") > -1) {
        if (cookie.length < 20) return;
        const oldCookie = $.getdata(KEY_COOKIE);
        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (ua) $.setdata(ua, KEY_UA);
            if (referer) $.setdata(referer, KEY_REFERER);
            $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°ï¼Œä¸‹æ¬¡ç­¾åˆ°æ˜¾ç¤ºè¯¦ç»†é¢æ¿");
        }
    }
}

// ------------------------------------------
// 2. ä¸»æµç¨‹
// ------------------------------------------
async function main() {
    const rawCookie = $.getdata(KEY_COOKIE);
    if (!rawCookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
        return;
    }

    // 1. ç­¾åˆ°
    const checkInRes = await doCheckIn(rawCookie);
    
    // 2. èŽ·å–è¯¦ç»†ä¿¡æ¯ (åªè¦å‡­è¯æ²¡è¿‡æœŸå°±åŽ»æŸ¥)
    let info = null;
    if (checkInRes.status !== 'expired') {
        info = await getUserInfo(rawCookie);
    }

    // 3. å‘é€é€šçŸ¥
    sendNotification(checkInRes, info);
}

// ------------------------------------------
// 3. ç­¾åˆ°è¯·æ±‚
// ------------------------------------------
async function doCheckIn(rawCookie) {
    const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";
    
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    const csrfToken = cookieObj['csrf_access_token'];

    if (!token) return { status: 'expired', msg: 'Cookieç¼ºå°‘token' };

    const headers = {
        'User-Agent': ua,
        'Accept': 'application/json, text/plain, */*',
        'Origin': `https://${DOMAIN}`,
        'Referer': referer,
        'Authorization': `Bearer ${token}`,
        'Cookie': rawCookie
    };
    if (csrfToken) headers['x-csrf-token'] = csrfToken;

    const req = {
        url: `https://${DOMAIN}/api/customer/user/checkin`,
        method: "POST",
        headers: headers,
        body: ""
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                resolve({ status: 'network', msg: 'ç½‘ç»œé”™è¯¯', earned: 0 });
                return;
            }
            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}
            const msg = resJson.message || "";
            const status = resp.status;

            // æå–èŽ·å¾—ç§¯åˆ†
            let earned = 0;
            const match = msg.match(/èŽ·å¾—\s*(\d+)\s*ç§¯åˆ†/);
            if (match) earned = match[1];

            if (status === 200 || status === 201) {
                resolve({ status: 'success', msg: msg, earned: earned });
            } else if (status === 400) {
                if (msg.includes("ç­¾åˆ°") || msg.includes("checked in")) {
                    resolve({ status: 'repeat', msg: msg, earned: 0 });
                } else {
                    resolve({ status: 'fail', msg: msg, earned: 0 });
                }
            } else if (status === 401 || status === 403) {
                resolve({ status: 'expired', msg: 'å‡­è¯è¿‡æœŸ', earned: 0 });
            } else {
                resolve({ status: 'unknown', msg: `Code: ${status}`, earned: 0 });
            }
        });
    });
}

// ------------------------------------------
// 4. èŽ·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ (7é¡¹æ•°æ®)
// ------------------------------------------
async function getUserInfo(rawCookie) {
    const ua = $.getdata(KEY_UA);
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];

    const req = {
        url: `https://${DOMAIN}/api/customer/user/info`,
        method: "GET",
        headers: {
            'User-Agent': ua,
            'Authorization': `Bearer ${token}`,
            'Cookie': rawCookie,
            'Accept': 'application/json'
        }
    };

    return new Promise(resolve => {
        $.get(req, (err, resp, data) => {
            if (err || resp.status !== 200) {
                console.log(`[HDHive] èŽ·å–ä¿¡æ¯å¤±è´¥: ${data}`);
                resolve(null);
                return;
            }
            try {
                const json = JSON.parse(data);
                const d = json.data || json; // å…¼å®¹ä¸åŒç»“æž„

                // å°è¯•æå–æ•°æ®ï¼Œå¦‚æžœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤å€¼
                return resolve({
                    name: d.username || d.name || "æœªçŸ¥",
                    id: d.id || "æœªçŸ¥",
                    // å°è¯•ä»Ž group æˆ– level å­—æ®µèŽ·å–ç­‰çº§åç§°
                    level: (d.group ? d.group.name : "") || d.level_name || d.class_name || "æ™®é€šç”¨æˆ·",
                    // åˆ†äº«/å‘å¸ƒæ•°é‡
                    share: d.share_count || d.publish_count || d.uploads || 0,
                    // å½“å‰ç§¯åˆ†
                    integral: d.integral || d.points || d.total_points || 0,
                    // ç´¯è®¡ç­¾åˆ°
                    checkins: d.checkin_count || d.total_checkin || d.sign_count || 0,
                    // åŠ å…¥æ—¶é—´ (åªæˆªå–æ—¥æœŸéƒ¨åˆ†)
                    join: (d.created_at || d.join_time || "æœªçŸ¥").substring(0, 10)
                });
            } catch (e) {
                console.log(`[HDHive] è§£æžä¿¡æ¯é”™è¯¯: ${e}`);
                resolve(null);
            }
        });
    });
}

// ------------------------------------------
// 5. æ ¼å¼åŒ–é€šçŸ¥
// ------------------------------------------
function sendNotification(res, info) {
    let title = "HDHive ç­¾åˆ°æ—¥æŠ¥";
    let body = "";

    // 1. è®¾ç½®æ ‡é¢˜çŠ¶æ€
    if (res.status === 'success') title = "âœ… HDHive ç­¾åˆ°æˆåŠŸ";
    else if (res.status === 'repeat') title = "ðŸŸ¢ HDHive ä»Šæ—¥å·²ç­¾";
    else if (res.status === 'expired') title = "ðŸ”´ HDHive å‡­è¯è¿‡æœŸ";
    else title = "âš ï¸ HDHive ç­¾åˆ°å¼‚å¸¸";

    // 2. æž„é€ æ­£æ–‡ (ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·è¦æ±‚æ ¼å¼)
    if (info) {
        // å¦‚æžœä»Šæ—¥æœ‰æ”¶ç›Šï¼Œåœ¨ç§¯åˆ†åŽé¢æ ‡æ³¨
        const earnedStr = res.earned > 0 ? ` (+${res.earned})` : "";
        
        body += `ç”¨æˆ·åç§°ï¼š${info.name}\n`;
        body += `ç”¨æˆ·lDï¼š${info.id}\n`;
        body += `ç”¨æˆ·ç­‰çº§ï¼š${info.level}\n`;
        body += `åˆ†äº«æ•°é‡ï¼š${info.share}\n`;
        body += `å½“å‰ç§¯åˆ†ï¼š${info.integral}${earnedStr}\n`;
        body += `ç´¯è®¡ç­¾åˆ°ï¼š${info.checkins}\n`;
        body += `åŠ å…¥æ—¶é—´ï¼š${info.join}`;
    } else {
        // å¦‚æžœèŽ·å–ä¿¡æ¯å¤±è´¥ï¼Œåªæ˜¾ç¤ºç­¾åˆ°ç»“æžœ
        body = `ç­¾åˆ°çŠ¶æ€ï¼š${res.msg}\næ— æ³•èŽ·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚`;
    }

    $.msg(title, "", body);
}

// ------------------------------------------
// å·¥å…·å‡½æ•°
// ------------------------------------------
function parseCookie(str) {
    const list = {};
    if (!str) return list;
    str.split(';').forEach(i => {
        const parts = i.split('=');
        if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
    });
    return list;
}

function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        get: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.get(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
