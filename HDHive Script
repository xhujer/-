const $ = new Env("HDHive");
const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const KEY_FLOW = 'hdhive_points_flow_v1';
const DOMAIN = 'hdhive.com';

(async () => {
  if (typeof $request !== "undefined") {
    await captureCookie();
  } else {
    await checkIn();
  }
})().catch(e => $.logErr(e)).finally(() => $.done());

async function captureCookie() {
  const url = $request.url || "";
  if (!url.includes(DOMAIN) || url.includes("user/checkin")) return;
  const h = $request.headers || {};
  const cookie = getHeader(h, 'Cookie');
  if (!cookie || !cookie.includes("token=")) return;
  const old = $.getdata(KEY_COOKIE);
  if (cookie !== old) {
    $.setdata(cookie, KEY_COOKIE);
    const ua = getHeader(h, 'User-Agent');
    const referer = getHeader(h, 'Referer');
    if (ua) $.setdata(ua, KEY_UA);
    if (referer) $.setdata(referer, KEY_REFERER);
    $.msg("HDHive", "ðŸŽ‰ Cookie å·²æ›´æ–°", "");
  }
}

async function activeFetchPointsFlow(headers) {
  const url = `https://${DOMAIN}/go-api/customer/points-logs?page=1&page_size=10`;
  try {
    const json = await httpGetJson(url, headers);
    const list = json?.data?.list;
    if (!Array.isArray(list) || !list.length) return null;
    const latest = list[0];
    const flow = {
      user_id: latest.user_id || "æœªçŸ¥",
      latest_checkin: {
        time: latest.created_at,
        points: latest.points,
        remark: latest.remark || latest.change_type || "å˜åŠ¨"
      },
      recent_checkins: list.slice(0, 3).map(x => `- ${formatTime(x.created_at)}ï¼š+${x.points}ï¼ˆ${x.remark || x.change_type}ï¼‰`)
    };
    $.setdata(JSON.stringify(flow), KEY_FLOW);
    return flow;
  } catch (e) {
    return null;
  }
}

function buildFlowText(flow) {
  if (!flow) return "";
  return [
    `ç”¨æˆ·IDï¼š${flow.user_id}`,
    `æœ€æ–°å˜åŠ¨ï¼š${formatTime(flow.latest_checkin.time)}`,
    `å˜åŠ¨æ•°å€¼ï¼š+${flow.latest_checkin.points} ç§¯åˆ†`,
    flow.latest_checkin.remark ? `è¯´æ˜Žï¼š${flow.latest_checkin.remark}` : "",
    "\nðŸ“ è¿‘æœŸæµæ°´ï¼š",
    ...flow.recent_checkins
  ].filter(Boolean).join("\n");
}

async function checkIn() {
  const rawCookie = $.getdata(KEY_COOKIE);
  if (!rawCookie) return $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æœªèŽ·å– Cookie");
  const token = parseCookie(rawCookie)['token'];
  const headers = {
    'User-Agent': $.getdata(KEY_UA) || 'Mozilla/5.0',
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json;charset=utf-8',
    'Origin': `https://${DOMAIN}`,
    'Referer': $.getdata(KEY_REFERER) || `https://${DOMAIN}/`,
    'Authorization': token ? `Bearer ${token}` : '',
    'Cookie': rawCookie
  };
  const req = { url: `https://${DOMAIN}/api/customer/user/checkin`, method: "POST", headers, body: "{}" };
  return new Promise(resolve => {
    $.post(req, async (err, resp, data) => {
      let msg = "è¯·æ±‚å¤±è´¥", isSuccess = false;
      if (!err && data) {
        try {
          const res = JSON.parse(data);
          msg = res.message || "æœªçŸ¥å“åº”";
          isSuccess = msg.includes("æˆåŠŸ") || msg.includes("å·²ç»") || msg.includes("æ˜Žå¤©");
        } catch (e) {}
      }
      let flow = await activeFetchPointsFlow(headers) || JSON.parse($.getdata(KEY_FLOW) || "null");
      $.msg("HDHive", isSuccess ? "ðŸŸ¢ ç­¾åˆ°æ‰§è¡Œå®Œæ¯•" : "âŒ ç­¾åˆ°å¼‚å¸¸", `${msg}\n\n${buildFlowText(flow)}`);
      resolve();
    });
  });
}

function httpGetJson(url, headers) {
  return new Promise((resolve, reject) => {
    $.get({ url, headers }, (err, resp, data) => {
      if (err) return reject(err);
      try { resolve(JSON.parse(data)); } catch (e) { reject(e); }
    });
  });
}

function parseCookie(str) {
  const obj = {};
  if (!str) return obj;
  str.split(';').forEach(p => {
    const i = p.indexOf('=');
    if (i > 0) obj[p.slice(0, i).trim()] = p.slice(i + 1).trim();
  });
  return obj;
}

function getHeader(h, k) {
  const key = k.toLowerCase();
  for (const i in h) if (i.toLowerCase() === key) return h[i];
  return null;
}

function formatTime(t) {
  if (!t) return "æœªçŸ¥æ—¶é—´";
  return t.replace("T", " ").replace(/\..*$/, "").replace(/\+\d\d:\d\d$/, "");
}

function Env(name) {
  return {
    name,
    getdata: k => $persistentStore.read(k),
    setdata: (v, k) => $persistentStore.write(v, k),
    post: (o, c) => $httpClient.post(o, c),
    get: (o, c) => $httpClient.get(o, c),
    msg: (t, s, b) => $notification.post(t, s, b),
    logErr: e => console.log(`! ${name}: ${e}`),
    done: () => $done({})
  };
}
