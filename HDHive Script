const $ = new Env("HDHive");

const DOMAIN = "hdhive.com";

const KEY_COOKIE = "hdhive_cookie_v15";
const KEY_REFERER = "hdhive_referer_v15";
const KEY_UA = "hdhive_ua_v15";
const KEY_CSRF = "hdhive_csrf_v15";
const KEY_FLOW = "hdhive_points_flow_v4";

// âœ… æ–°å¢žï¼šè®°å½•æœ€åŽå‘½ä¸­çš„ç­¾åˆ°æŽ¥å£
const KEY_LAST_CHECKIN_URL = "hdhive_checkin_last_url";

(async () => {
  if (typeof $request !== "undefined") {
    await captureCookie();
  } else {
    await checkIn();
  }
})().catch(e => $.logErr(e)).finally(() => $.done());

async function captureCookie() {
  const url = $request.url || "";
  if (!url.includes(DOMAIN)) return;

  if (/\/(go-api|api)\/customer\/(user\/)?checkin/i.test(url)) return;

  if (!/\/manager\/|\/api\/|\/go-api\/|https:\/\/hdhive\.com\/?$/.test(url)) return;

  const h = $request.headers || {};
  const cookie = getCookieFromHeaders(h);
  const ua = getHeader(h, "User-Agent");
  const referer = getHeader(h, "Referer");

  if (!cookie || cookie.length < 20) return;

  const normCookie = normalizeCookie(cookie);
  const ckObj = parseCookie(normCookie);
  if (!ckObj.token) return;

  const old = $.getdata(KEY_COOKIE);
  if (normCookie !== old) {
    $.setdata(normCookie, KEY_COOKIE);
    if (ua) $.setdata(ua, KEY_UA);
    if (referer) $.setdata(referer, KEY_REFERER);
    if (ckObj.csrf_access_token) $.setdata(ckObj.csrf_access_token, KEY_CSRF);

    $.msg("HDHive", "ðŸŽ‰ Cookie å·²æ›´æ–°", "å¯ä»¥å…³é—­è‡ªåŠ¨èŽ·å–å¼€å…³");
  }
}

async function activeFetchPointsFlow(headers) {
  const url = `https://${DOMAIN}/manager/points-logs?page=1&page_size=10&_rsc=1`;

  try {
    const raw = await httpGetText(url, headers);
    if (!raw || raw.length < 200) return null;

    const list = extractInitialDataArray(raw);
    if (!Array.isArray(list) || !list.length) return null;

    const latest = list[0];
    const recent = list.slice(0, 3).map(x =>
      `- ${formatTime(x.created_at)}ï¼š${x.points > 0 ? "+" : ""}${x.points}ï¼ˆ${x.remark || x.change_type || ""}ï¼‰`
    );

    const flow = {
      user_id: latest.user_id,
      latest_checkin: {
        time: latest.created_at,
        points: latest.points,
        remark: latest.remark || latest.change_type
      },
      recent_checkins: recent
    };

    $.setdata(JSON.stringify(flow), KEY_FLOW);
    return flow;
  } catch {
    return null;
  }
}

function buildFlowText(flow) {
  if (!flow) return "";
  const l = [];
  if (flow.user_id) l.push(`ç”¨æˆ·IDï¼š${flow.user_id}`);
  if (flow.latest_checkin?.time) l.push(`æœ€æ–°å˜åŠ¨ï¼š${formatTime(flow.latest_checkin.time)}`);
  if (flow.latest_checkin?.points !== undefined)
    l.push(`å˜åŠ¨æ•°å€¼ï¼š${flow.latest_checkin.points > 0 ? "+" : ""}${flow.latest_checkin.points} ç§¯åˆ†`);
  if (flow.latest_checkin?.remark) l.push(`å†…å®¹æè¿°ï¼š${flow.latest_checkin.remark}`);
  if (flow.recent_checkins?.length) {
    l.push("");
    l.push("ðŸ“ ç§¯åˆ†æ—¥å¿—ï¼š");
    l.push(flow.recent_checkins.join("\n"));
  }
  return l.join("\n");
}

async function checkIn() {
  const rawCookie = $.getdata(KEY_COOKIE);
  if (!rawCookie) {
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æœªèŽ·å– Cookie");
    return;
  }

  const ckObj = parseCookie(rawCookie);
  const token = ckObj.token;
  if (!token) {
    $.msg("HDHive", "âŒ Cookie å¤±æ•ˆ", "ç¼ºå°‘ token");
    return;
  }

  const ua =
    $.getdata(KEY_UA) ||
    "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.2 Mobile/15E148 Safari/604.1";

  const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/manager/points-logs`;
  const csrf = $.getdata(KEY_CSRF) || ckObj.csrf_access_token || "";

  const headers = {
    "User-Agent": ua,
    "Origin": `https://${DOMAIN}`,
    "Referer": referer,
    "Accept-Language": "zh-CN,zh-Hans;q=0.9",
    "Cookie": normalizeCookie(rawCookie),
    "rsc": "1",
    "next-url": "/manager/points-logs",
  };

  headers["Accept"] = "text/x-component,*/*";
  headers["Authorization"] = `Bearer ${token}`;

  if (csrf) {
    headers["X-CSRF-Token"] = csrf;
    headers["X-Csrf-Token"] = csrf;
  }

  const postHeaders = Object.assign({}, headers, {
    "Accept": "application/json, text/plain, */*",
    "Content-Type": "application/json;charset=utf-8",
  });

  const endpoints = [
    `https://${DOMAIN}/api/customer/user/checkin`,
    `https://${DOMAIN}/go-api/customer/user/checkin`,
    `https://${DOMAIN}/api/customer/checkin`,
    `https://${DOMAIN}/go-api/customer/checkin`,
  ];

  let checkinRes = null;
  let status = 0;
  let raw = "";
  let hitUrl = "";

  // âœ… æ–°å¢žï¼šæ¯ä¸ªå€™é€‰æŽ¥å£éƒ½æ‰“å°å°è¯•æ—¥å¿—ï¼›å‘½ä¸­åŽè®°å½•
  for (const url of endpoints) {
    console.log("HDHive try checkin:", url);

    const req = { url, method: "POST", headers: postHeaders, body: "{}" };
    const r = await httpPostRaw(req);
    if (!r) {
      console.log("HDHive checkin no response:", url);
      continue;
    }

    status = r.status;
    raw = r.data || "";
    console.log("HDHive checkin status:", status, "url:", url);

    let json = null;
    try { json = JSON.parse(raw); } catch {}

    if (!json) {
      console.log("HDHive checkin non-JSON:", url, "raw:", String(raw).slice(0, 120));
      continue;
    }

    hitUrl = url;
    checkinRes = json;

    console.log("HDHive checkin endpoint hit:", hitUrl);
    $.setdata(hitUrl, KEY_LAST_CHECKIN_URL);

    break;
  }

  let title = "ðŸ“Œ ç­¾åˆ°ç»“æžœ";
  let showText = "æœªèŽ·å–åˆ°æœ‰æ•ˆç­¾åˆ°å“åº”";

  if (checkinRes) {
    const msg = checkinRes.message || checkinRes.msg || "";
    const desc = checkinRes.description || checkinRes.desc || "";
    showText = (desc || msg || "ï¼ˆæ— æç¤ºæ–‡æœ¬ï¼‰");
  } else {
    showText = `HTTP ${status}\nè¿”å›žç‰‡æ®µï¼š${String(raw).slice(0, 200)}`;

    // âœ… æ–°å¢žï¼šæŠŠâ€œæœ€åŽä¸€æ¬¡å‘½ä¸­çš„æŽ¥å£ï¼ˆå¦‚æžœæœ‰ï¼‰â€ä¹Ÿæ‰“å°å‡ºæ¥å¸®åŠ©æŽ’æŸ¥
    const last = $.getdata(KEY_LAST_CHECKIN_URL) || "";
    if (last) console.log("HDHive last hit checkin url:", last);
  }

  let flow = await activeFetchPointsFlow(headers);
  if (!flow) {
    try { flow = JSON.parse($.getdata(KEY_FLOW) || "null"); } catch {}
  }

  const flowText = flow
    ? "\n\n" + buildFlowText(flow)
    : "\n\nï¼ˆæœªæ‹‰åˆ°ç§¯åˆ†æ—¥å¿—ï¼šå¯èƒ½æ˜¯ MITM æœªè§£å¯† / è¿”å›žéž RSC / Cookie æ— æƒé™ï¼‰";

  $.msg("HDHive", title, `${showText}${flowText}`);
}

function httpGetText(url, headers) {
  return new Promise((resolve, reject) => {
    $.get({ url, headers }, (err, resp, data) => {
      if (err) return reject(err);
      resolve(typeof data === "string" ? data : "");
    });
  });
}

function httpPostRaw(req) {
  return new Promise((resolve) => {
    $.post(req, (err, resp, data) => {
      if (err) return resolve(null);
      const status = resp?.status || resp?.statusCode || 0;
      resolve({ status, data: (typeof data === "string" ? data : "") });
    });
  });
}

function extractInitialDataArray(raw) {
  const key = '"initialData":';
  const idx = raw.indexOf(key);
  if (idx < 0) return null;

  let i = raw.indexOf("[", idx + key.length);
  if (i < 0) return null;

  let depth = 0;
  let inStr = false;
  let esc = false;

  for (let j = i; j < raw.length; j++) {
    const ch = raw[j];

    if (inStr) {
      if (esc) { esc = false; continue; }
      if (ch === "\\") { esc = true; continue; }
      if (ch === '"') inStr = false;
      continue;
    } else {
      if (ch === '"') { inStr = true; continue; }
      if (ch === "[") depth++;
      if (ch === "]") {
        depth--;
        if (depth === 0) {
          const jsonText = raw.slice(i, j + 1);
          try { return JSON.parse(jsonText); } catch { return null; }
        }
      }
    }
  }
  return null;
}

function getCookieFromHeaders(h) {
  let v = null;
  for (const k in h) {
    if (k.toLowerCase() === "cookie") { v = h[k]; break; }
  }
  if (!v) return null;
  if (Array.isArray(v)) return normalizeCookie(v.join("; "));
  return normalizeCookie(String(v));
}

function normalizeCookie(str) {
  return String(str)
    .replace(/\r?\n/g, "; ")
    .replace(/;+\s*/g, "; ")
    .replace(/\s*;\s*$/, "")
    .trim();
}

function parseCookie(str) {
  const obj = {};
  normalizeCookie(str).split(";").forEach(p => {
    const i = p.indexOf("=");
    if (i > 0) obj[p.slice(0, i).trim()] = p.slice(i + 1).trim();
  });
  return obj;
}

function getHeader(h, k) {
  const key = k.toLowerCase();
  for (const i in h) {
    if (i.toLowerCase() === key) return h[i];
  }
  return null;
}

function formatTime(t) {
  return (t || "")
    .replace("T", " ")
    .replace(/\..*$/, "")
    .replace(/\+\d\d:\d\d$/, "");
}

function Env(name) {
  return {
    name,
    getdata: k => $persistentStore?.read(k),
    setdata: (v, k) => $persistentStore?.write(v, k),
    post: (o, c) => $httpClient?.post(o, c),
    get: (o, c) => $httpClient?.get(o, c),
    msg: (t, s, b) => {
      $notification?.post(t, s, b);
      console.log(`===${t}===\n${s}\n${b}`);
    },
    logErr: e => console.log(`â—ï¸${name}: ${e}`),
    done: () => $done?.({})
  };
}