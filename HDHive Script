/*
HDHive Ëá™Âä®Á≠æÂà∞ (Loon ÂéüÁîü‰∏ìÁî®Áâà)
Update: 2026-01-16
Author: ming
Desc: ÂéªÈô§‰∫ÜÊâÄÊúâ Env ÂÖºÂÆπÂ±ÇÔºåÁõ¥Êé•Ë∞ÉÁî® Loon APIÔºåÂΩªÂ∫ïËß£ÂÜ≥Êä•Èîô„ÄÇ
*/

// --- ÂèòÈáèÂÆö‰πâ ---
const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const KEY_USER_ID = 'hdhive_uid_v1';
const DOMAIN = 'hdhive.com';

const API_CHECKIN = `https://${DOMAIN}/api/customer/user/checkin`;
const API_LOGS = `https://${DOMAIN}/go-api/customer/points-logs?page=1&page_size=10`;

// --- ‰∏ªÈÄªËæë ---
(async () => {
  // Âà§Êñ≠ÊòØËÑöÊú¨ËøêË°åËøòÊòØ cron ËøêË°å
  if (typeof $request !== "undefined") {
    await captureCookie();
  } else {
    await runCron();
  }
})()
  .catch((e) => console.log(`‚ùå ËÑöÊú¨Â¥©Ê∫É: ${e}`))
  .finally(() => $done());

async function runCron() {
  const cookie = $persistentStore.read(KEY_COOKIE);
  if (!cookie) {
    $notification.post("HDHive", "‚ùå Êó†Ê≥ïÊâßË°å", `Êú™ÊâæÂà∞ CookieÔºåËØ∑ÂÖàËÆøÈóÆ ${DOMAIN} ÁôªÂΩï`);
    return;
  }

  // 1. Á≠æÂà∞
  const checkInResult = await doCheckIn(cookie);

  // 2. Âè™ÊúâÊàêÂäüÊàñÈáçÂ§çÊó∂ÔºåÂª∂ËøüÊãâÂèñÊó•Âøó
  if (checkInResult.success || checkInResult.isRepeated) {
    await new Promise(r => setTimeout(r, 2000));
  }
  const serverLogs = await fetchPointsLog(cookie);

  // 3. ÁîüÊàêÊñáÊ°à
  const finalContent = buildFinalContent(checkInResult, serverLogs);

  // 4. ÈÄöÁü•
  $notification.post("HDHive", checkInResult.title, finalContent);
  console.log(`\n${checkInResult.title}\n${finalContent}`);
}

// --- ÂäüËÉΩÂáΩÊï∞ ---

function buildFinalContent(checkInRes, serverLogs) {
  const logs = serverLogs || [];
  
  // Â§ÑÁêÜ UserID
  let userId = $persistentStore.read(KEY_USER_ID) || "Êú™Áü•";
  if (logs.length > 0 && logs[0].user_id) {
    userId = logs[0].user_id;
    $persistentStore.write(String(userId), KEY_USER_ID);
  }

  // Êô∫ËÉΩË°•ÂÖ®Êó•Âøó
  let currentLog = null;
  const isServerUpdated = logs.length > 0 && 
                          logs[0].change_type === "Á≠æÂà∞" && 
                          isToday(logs[0].created_at);

  if (isServerUpdated) {
    currentLog = logs[0];
  } else if (checkInRes.success) {
    currentLog = {
      created_at: getNowStr(),
      points: checkInRes.points,
      remark: checkInRes.raw_msg || "Á≠æÂà∞ÊàêÂäü",
      user_id: userId
    };
    logs.unshift(currentLog);
  } else {
    currentLog = logs[0] || { created_at: "", points: 0, remark: "Êó†ËÆ∞ÂΩï" };
  }

  const lines = [];
  lines.push(checkInRes.raw_msg || checkInRes.message); 
  lines.push("");
  lines.push(`Áî®Êà∑IDÔºö${userId}`);
  lines.push(`ÊúÄËøëÁ≠æÂà∞Ôºö${formatTime(currentLog.created_at)}`);
  lines.push(`Êú¨Ê¨°Ëé∑ÂæóÔºö+${currentLog.points} ÁßØÂàÜ`);
  lines.push(`ËØ¥ÊòéÔºö${currentLog.remark}`);
  lines.push("");
  lines.push("ÊúÄËøëÁ≠æÂà∞ËÆ∞ÂΩïÔºö");

  logs.slice(0, 5).forEach(log => {
    const time = formatTime(log.created_at);
    const pts = log.points;
    const remark = log.remark || log.change_type || "Á≠æÂà∞";
    lines.push(`- ${time}Ôºö+${pts}Ôºà${remark}Ôºâ`);
  });

  return lines.join("\n");
}

async function doCheckIn(cookie) {
  const headers = buildHeaders(cookie);
  headers['Content-Type'] = 'application/json';

  return new Promise(resolve => {
    $httpClient.post({
      url: API_CHECKIN,
      headers: headers,
      body: "{}"
    }, (error, response, data) => {
      if (error) {
        resolve({ success: false, points: 0, title: "‚ùå ÁΩëÁªúÈîôËØØ", message: "ËØ∑Ê±ÇÂ§±Ë¥•", raw_msg: "Network Error" });
        return;
      }
      
      let res = {};
      try { res = JSON.parse(data); } catch (e) { res = { message: data }; }
      const msg = res.message || "";
      const pointsMatch = msg.match(/(\d+)\s*ÁßØÂàÜ/);
      const gainedPoints = pointsMatch ? parseInt(pointsMatch[1], 10) : 0;

      if (response.status === 200 || response.status === 201) {
        resolve({ success: true, isRepeated: false, points: gainedPoints, title: "‚úÖ Á≠æÂà∞ÊàêÂäü", message: msg, raw_msg: msg });
      } else if (response.status === 400) {
        if (msg.includes("Â∑≤ÁªèÁ≠æÂà∞") || msg.includes("checked in")) {
          resolve({ success: false, isRepeated: true, points: 0, title: "üü¢ Á≠æÂà∞ÊàêÂäü", message: msg, raw_msg: msg });
        } else {
          resolve({ success: false, points: 0, title: "‚ö†Ô∏è Á≠æÂà∞Â§±Ë¥•", message: msg, raw_msg: msg });
        }
      } else if (response.status === 401 || response.status === 403) {
        resolve({ success: false, points: 0, title: "üî¥ Cookie Â§±Êïà", message: "TokenËøáÊúü", raw_msg: "Token Invalid" });
      } else {
        resolve({ success: false, points: 0, title: "‚ùå Êú™Áü•ÈîôËØØ", message: msg, raw_msg: msg });
      }
    });
  });
}

async function fetchPointsLog(cookie) {
  return new Promise(resolve => {
    $httpClient.get({
      url: API_LOGS,
      headers: buildHeaders(cookie)
    }, (error, response, data) => {
      if (error) { resolve([]); return; }
      try {
        const json = JSON.parse(data);
        if (json && json.data && Array.isArray(json.data.list)) {
          resolve(json.data.list);
        } else {
          resolve([]);
        }
      } catch (e) { resolve([]); }
    });
  });
}

async function captureCookie() {
  const url = $request.url;
  if (url.includes("/user/checkin") || url.includes("points-logs")) return;
  
  const h = $request.headers;
  const cookie = h['Cookie'] || h['cookie'];
  if (cookie && cookie.includes("token=")) {
    const old = $persistentStore.read(KEY_COOKIE);
    if (cookie !== old) {
      $persistentStore.write(cookie, KEY_COOKIE);
      const ua = h['User-Agent'] || h['user-agent'];
      const ref = h['Referer'] || h['referer'];
      if(ua) $persistentStore.write(ua, KEY_UA);
      if(ref) $persistentStore.write(ref, KEY_REFERER);
      $notification.post("HDHive", "üéâ Cookie Êõ¥Êñ∞", "Ëé∑ÂèñÊàêÂäü");
    }
  }
}

// --- Â∑•ÂÖ∑ ---
function buildHeaders(cookie) {
  const ua = $persistentStore.read(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";
  const referer = $persistentStore.read(KEY_REFERER) || `https://${DOMAIN}/`;
  const token = (cookie.match(/token=([^;]+)/) || [])[1] || "";
  return { 
    'User-Agent': ua, 
    'Referer': referer, 
    'Origin': `https://${DOMAIN}`, 
    'Cookie': cookie, 
    'Authorization': `Bearer ${token}` 
  };
}

function getNowStr() {
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  return new Date(now.getTime() - offset).toISOString().replace("Z", "");
}

function formatTime(isoStr) {
  if (!isoStr) return "Êú™Áü•Êó∂Èó¥";
  return isoStr.replace("T", " ").replace(/\.\d+Z?$/, "").replace(/\+\d{2}:\d{2}$/, "").substring(0, 19);
}

function isToday(isoStr) {
  if (!isoStr) return false;
  return isoStr.slice(0, 10) === getNowStr().slice(0, 10);
}
