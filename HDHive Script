/*
HDHive è‡ªåŠ¨ç­¾åˆ°è„šæœ¬
Update: 2026-01-16
Author: ming (final minimal)
*/

const $ = new Env("HDHive");

// ========= é…ç½® =========
const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const DOMAIN = 'hdhive.com';

// ========= å…¥å£ =========
(async () => {
  if (typeof $request !== "undefined") {
    await captureCookie();
  } else {
    await checkIn();
  }
})().catch(e => $.logErr(e)).finally(() => $.done());

// ========= æŠ“ Cookie =========
async function captureCookie() {
  const url = $request.url || "";
  if (!url.includes(DOMAIN)) return;
  if (url.includes("user/checkin")) return;

  const h = $request.headers || {};
  const cookie = getHeader(h, 'Cookie');
  const ua = getHeader(h, 'User-Agent');
  const referer = getHeader(h, 'Referer');

  if (!cookie || !cookie.includes("token=")) return;
  if (cookie.length < 20) return;

  const old = $.getdata(KEY_COOKIE);
  if (cookie !== old) {
    $.setdata(cookie, KEY_COOKIE);
    if (ua) $.setdata(ua, KEY_UA);
    if (referer) $.setdata(referer, KEY_REFERER);
    $.msg("HDHive", "ðŸŽ‰ Cookie å·²æ›´æ–°", "å¯ä»¥å…³é—­è‡ªåŠ¨èŽ·å–å¼€å…³");
  }
}

// ========= ä¸»åŠ¨èŽ·å–ç§¯åˆ†=========
async function activeFetchPoints(headers) {
  const url = `https://${DOMAIN}/go-api/customer/points-logs?page=1`;
  try {
    const json = await httpGetJson(url, headers);
    const list = json?.data?.list;
    if (!Array.isArray(list) || !list.length) return null;

    const x = list[0]; // æœ€æ–°ä¸€æ¡
    return {
      time: x.created_at,
      points: x.points,
      remark: x.remark || x.change_type || "ç§¯åˆ†å˜åŠ¨"
    };
  } catch {
    return null;
  }
}

// ========= ç­¾åˆ° =========
async function checkIn() {
  const rawCookie = $.getdata(KEY_COOKIE);
  if (!rawCookie) {
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æœªèŽ·å– Cookie");
    return;
  }

  const token = parseCookie(rawCookie)['token'];
  if (!token) {
    $.msg("HDHive", "âŒ Cookie å¤±æ•ˆ", "ç¼ºå°‘ token");
    return;
  }

  const headers = {
    'User-Agent': $.getdata(KEY_UA) || 'Mozilla/5.0',
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json;charset=utf-8',
    'Origin': `https://${DOMAIN}`,
    'Referer': $.getdata(KEY_REFERER) || `https://${DOMAIN}/`,
    'Authorization': `Bearer ${token}`,
    'Cookie': rawCookie
  };

  const req = {
    url: `https://${DOMAIN}/api/customer/user/checkin`,
    method: "POST",
    headers,
    body: "{}"
  };

  return new Promise(resolve => {
    $.post(req, async (err, resp, data) => {
      if (err) {
        $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥");
        resolve();
        return;
      }

      let msg = "";
      try { msg = JSON.parse(data)?.message || ""; } catch {}

      const p = await activeFetchPoints(headers);
      const text = p
        ? `\n\næœ€è¿‘ç§¯åˆ†ï¼š${formatTime(p.time)}\n+${p.points}ï¼ˆ${p.remark}ï¼‰`
        : "";

      $.msg(
        "HDHive",
        msg.includes("å·²") ? "ðŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°" : "âœ… ç­¾åˆ°å®Œæˆ",
        `${msg || ""}${text}`
      );
      resolve();
    });
  });
}

// ========= å·¥å…· =========
function httpGetJson(url, headers) {
  return new Promise((resolve, reject) => {
    $.get({ url, headers }, (err, resp, data) => {
      if (err) return reject(err);
      try { resolve(JSON.parse(data)); } catch (e) { reject(e); }
    });
  });
}

function parseCookie(str) {
  const obj = {};
  str.split(';').forEach(p => {
    const i = p.indexOf('=');
    if (i > 0) obj[p.slice(0, i).trim()] = p.slice(i + 1).trim();
  });
  return obj;
}

function getHeader(h, k) {
  const key = k.toLowerCase();
  for (const i in h) {
    if (i.toLowerCase() === key) return h[i];
  }
  return null;
}

function formatTime(t) {
  return (t || "").replace("T", " ").replace(/\+\d\d:\d\d$/, "");
}

// ========= Env =========
function Env(name) {
  return {
    name,
    getdata: k => $persistentStore?.read(k),
    setdata: (v, k) => $persistentStore?.write(v, k),
    post: (o, c) => $httpClient?.post(o, c),
    get: (o, c) => $httpClient?.get(o, c),
    msg: (t, s, b) => {
      $notification?.post(t, s, b);
      console.log(`===${t}===\n${s}\n${b}`);
    },
    logErr: e => console.log(`â—ï¸${name}: ${e}`),
    done: () => $done?.({})
  };
}