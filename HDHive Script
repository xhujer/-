const $ = new Env("HDHive");

// ========= å¸¸é‡ =========
const DOMAIN = "hdhive.com";

const KEY_COOKIE = "hdhive_cookie_v13";
const KEY_UA = "hdhive_ua_v13";
const KEY_REFERER = "hdhive_referer_v13";
const KEY_CSRF = "hdhive_csrf_v13";
const KEY_FLOW = "hdhive_points_flow_v2";

// ========= å…¥å£ =========
(async () => {
  if (typeof $request !== "undefined") {
    await captureCookie();
  } else {
    await checkIn();
  }
})()
  .catch((e) => $.logErr(e))
  .finally(() => $.done());

// ========= æŠ“ Cookieï¼ˆå¢å¼ºï¼šåˆå¹¶å¤šæ®µ Cookieï¼›æå– csrf_access_tokenï¼‰ =========
async function captureCookie() {
  const url = $request.url || "";
  if (!url.includes(DOMAIN)) return;

  // é¿å…æŠŠç­¾åˆ°è¯·æ±‚çš„ä¸´æ—¶å¤´è¦†ç›–æ‰ï¼ˆä¿ç•™ä½ çš„é€»è¾‘ï¼ŒåŒæ—¶æ›´å®½æ¾åŒ¹é…ï¼‰
  if (/\/(go-api|api)\/customer\/user\/checkin/i.test(url)) return;

  const h = $request.headers || {};
  const cookie = getCookieFromHeaders(h); // âœ… åˆå¹¶å¤šè¡Œ cookie
  const ua = getHeader(h, "User-Agent");
  const referer = getHeader(h, "Referer");

  if (!cookie || cookie.length < 20) return;

  const ckObj = parseCookie(cookie);
  if (!ckObj.token) return; // å¿…é¡»æœ‰ token

  const old = $.getdata(KEY_COOKIE);
  if (cookie !== old) {
    $.setdata(cookie, KEY_COOKIE);
    if (ua) $.setdata(ua, KEY_UA);

    // âœ… æŠ“åŒ…é‡Œ referer å¸¸è§ä¸º /manager/points-logs
    if (referer) $.setdata(referer, KEY_REFERER);

    // âœ… æŠ“åŒ…é‡Œå­˜åœ¨ csrf_access_token
    if (ckObj.csrf_access_token) $.setdata(ckObj.csrf_access_token, KEY_CSRF);

    $.msg("HDHive", "ğŸ‰ Cookie å·²æ›´æ–°", "å·²ä¿å­˜ token + csrf_access_tokenï¼ˆå¦‚æœ‰ï¼‰");
  }
}

// ========= ä¸»åŠ¨è·å–ç§¯åˆ†æ—¥å¿—ï¼ˆå¤š endpoint fallbackï¼‰ =========
async function activeFetchPointsFlow(headers) {
  const candidates = [
    `https://${DOMAIN}/go-api/customer/points-logs?page=1&page_size=10`,
    `https://${DOMAIN}/api/customer/points-logs?page=1&page_size=10`,
    `https://${DOMAIN}/go-api/customer/points-logs?page=1&page_size=10&sort=created_at:desc`,
  ];

  for (const url of candidates) {
    try {
      const json = await httpGetJson(url, headers);
      const list = json?.data?.list || json?.data?.items || json?.list;
      if (!Array.isArray(list) || !list.length) continue;

      const latest = list[0];
      const recent = list.slice(0, 3).map((x) => {
        const pts = x.points ?? x.change_points ?? x.value ?? 0;
        const remark = x.remark || x.change_type || x.type || "";
        return `- ${formatTime(x.created_at || x.createdAt || x.time)}ï¼š${pts > 0 ? "+" : ""}${pts}ï¼ˆ${remark}ï¼‰`;
      });

      const flow = {
        user_id: latest.user_id || latest.userId || "",
        latest_checkin: {
          time: latest.created_at || latest.createdAt || latest.time,
          points: latest.points ?? latest.change_points ?? latest.value ?? 0,
          remark: latest.remark || latest.change_type || latest.type || "",
        },
        recent_checkins: recent,
      };

      $.setdata(JSON.stringify(flow), KEY_FLOW);
      return flow;
    } catch {
      // try next
    }
  }

  return null;
}

// ========= æ„å»ºå±•ç¤ºæ–‡æœ¬ =========
function buildFlowText(flow) {
  if (!flow) return "";
  const l = [];
  if (flow.user_id) l.push(`ç”¨æˆ·IDï¼š${flow.user_id}`);
  if (flow.latest_checkin?.time) l.push(`æœ€æ–°å˜åŠ¨ï¼š${formatTime(flow.latest_checkin.time)}`);
  if (flow.latest_checkin?.points !== undefined)
    l.push(`å˜åŠ¨æ•°å€¼ï¼š${flow.latest_checkin.points > 0 ? "+" : ""}${flow.latest_checkin.points} ç§¯åˆ†`);
  if (flow.latest_checkin?.remark) l.push(`å†…å®¹æè¿°ï¼š${flow.latest_checkin.remark}`);

  if (flow.recent_checkins?.length) {
    l.push("");
    l.push("ğŸ“ ç§¯åˆ†æ—¥å¿—ï¼š");
    l.push(flow.recent_checkins.join("\n"));
  }
  return l.join("\n");
}

// ========= ç­¾åˆ°ï¼ˆå¢å¼ºï¼šcsrf + endpoint fallback + æ›´è´´è¿‘æŠ“åŒ…çš„é»˜è®¤å¤´ï¼‰ =========
async function checkIn() {
  const rawCookie = $.getdata(KEY_COOKIE);
  if (!rawCookie) {
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æœªè·å– Cookie");
    return;
  }

  const ckObj = parseCookie(rawCookie);
  const token = ckObj.token;
  if (!token) {
    $.msg("HDHive", "âŒ Cookie å¤±æ•ˆ", "ç¼ºå°‘ token");
    return;
  }

  // âœ… æŠ“åŒ…é‡Œ cookie è¿˜æœ‰ csrf_access_token
  const csrf = $.getdata(KEY_CSRF) || ckObj.csrf_access_token || "";

  // âœ… æŠ“åŒ… UA æ˜¯ iPhone Safariï¼›è¿™é‡Œä¿ç•™ä½ å­˜çš„ UAï¼Œæ²¡å­˜å°±ç”¨ä¸€ä¸ªæ›´åƒæµè§ˆå™¨çš„
  const ua =
    $.getdata(KEY_UA) ||
    "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.2 Mobile/15E148 Safari/604.1";

  // âœ… é»˜è®¤ referer è´´è¿‘æŠ“åŒ…é¡µé¢
  const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/manager/points-logs`;

  const baseHeaders = {
    "User-Agent": ua,
    Accept: "application/json, text/plain, */*",
    "Content-Type": "application/json;charset=utf-8",
    Origin: `https://${DOMAIN}`,
    Referer: referer,
    "Accept-Language": "zh-CN,zh-Hans;q=0.9",
    Cookie: normalizeCookie(rawCookie),
    Authorization: `Bearer ${token}`,
  };

  // âœ… å¦‚æœæœåŠ¡ç«¯åšåŒé‡ CSRF æ ¡éªŒï¼Œè¿™ä¸ªå¤´èƒ½æ˜¾è‘—æé«˜æˆåŠŸç‡ï¼ˆæ— å‰¯ä½œç”¨ï¼‰
  if (csrf) {
    baseHeaders["X-CSRF-Token"] = csrf;
    baseHeaders["X-Csrf-Token"] = csrf; // å…¼å®¹ä¸åŒå¤§å°å†™å®ç°
  }

  // âœ… å¤š endpoint fallbackï¼ˆæŠ“åŒ…é‡Œæ²¡çœ‹åˆ° checkinï¼Œæ‰€ä»¥åšç¨³å¦¥å¤„ç†ï¼‰
  const endpoints = [
    `https://${DOMAIN}/api/customer/user/checkin`,
    `https://${DOMAIN}/go-api/customer/user/checkin`,
    `https://${DOMAIN}/api/customer/checkin`,
    `https://${DOMAIN}/go-api/customer/checkin`,
  ];

  let res = null;
  let lastRaw = "";
  for (const url of endpoints) {
    const req = { url, method: "POST", headers: baseHeaders, body: "{}" };
    const r = await httpPostJson(req);
    if (!r) continue;
    lastRaw = r.raw || "";
    res = r.json || {};
    // ä¸€èˆ¬æˆåŠŸéƒ½ä¼šæœ‰ message/code/dataï¼›è¿™é‡Œåšâ€œåƒæˆåŠŸâ€çš„åˆ¤æ–­
    if (r.ok && (res?.message || res?.data || res?.code !== undefined)) break;
  }

  if (!res) {
    $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥ / æ— å“åº”");
    return;
  }

  const msg = res.message || res.msg || "";
  const checked =
    /å·²ç»|æ˜å¤©/.test(msg) || msg.toLowerCase().includes("checked") || msg.toLowerCase().includes("already");

  // ç§¯åˆ†æ—¥å¿—
  let flow = await activeFetchPointsFlow(baseHeaders);
  if (!flow) {
    try {
      flow = JSON.parse($.getdata(KEY_FLOW) || "null");
    } catch {}
  }

  const flowText = flow ? "\n\n" + buildFlowText(flow) : "";

  $.msg("HDHive", checked ? "ğŸŸ¢ ä»Šæ—¥å·²æ‰§è¡Œ" : "âœ… ç­¾åˆ°æˆåŠŸè®°å½•", `${msg || "å·²è¯·æ±‚ç­¾åˆ°"}${flowText}`);

  // æ–¹ä¾¿ä½ æ’æŸ¥ï¼šå¦‚æœ message ä¸ºç©ºï¼Œå¯ä»¥æŠŠ lastRaw è¾“å‡ºåˆ°æ—¥å¿—çœ‹è¿”å›
  if (!msg && lastRaw) console.log("HDHive raw response:", lastRaw);
}

// ========= HTTP å·¥å…· =========
function httpGetJson(url, headers) {
  return new Promise((resolve, reject) => {
    $.get({ url, headers }, (err, resp, data) => {
      if (err) return reject(err);
      try {
        resolve(JSON.parse(data));
      } catch (e) {
        reject(e);
      }
    });
  });
}

function httpPostJson(req) {
  return new Promise((resolve) => {
    $.post(req, (err, resp, data) => {
      if (err) return resolve(null);
      let json = null;
      try {
        json = JSON.parse(data);
      } catch {}
      const ok = resp && (resp.status === 200 || resp.statusCode === 200);
      resolve({ ok, json, raw: data, resp });
    });
  });
}

// ========= Cookie/Headers å·¥å…·ï¼ˆå¢å¼ºï¼‰ =========

// æŠ“åŒ…é‡Œå¯èƒ½å‡ºç°å¤šä¸ª cookie è¡Œï¼Œè¿™é‡Œåˆå¹¶ï¼ˆSurge/QuanX æœ‰æ—¶æ˜¯ stringï¼Œæœ‰æ—¶æ˜¯ arrayï¼‰
function getCookieFromHeaders(h) {
  // å¸¸è§ï¼šh['Cookie']ï¼›ä¹Ÿå¯èƒ½ï¼šh['cookie']ï¼›ä¹Ÿå¯èƒ½æ˜¯æ•°ç»„
  let v = null;
  for (const k in h) {
    if (k.toLowerCase() === "cookie") {
      v = h[k];
      break;
    }
  }
  if (!v) return null;
  if (Array.isArray(v)) return normalizeCookie(v.join("; "));
  return normalizeCookie(String(v));
}

function normalizeCookie(str) {
  // å…¼å®¹ï¼šæ¢è¡Œã€å¤šä¸ªç©ºæ ¼ã€é‡å¤åˆ†å·
  return String(str)
    .replace(/\r?\n/g, "; ")
    .replace(/;+\s*/g, "; ")
    .replace(/\s*;\s*$/, "")
    .trim();
}

function parseCookie(str) {
  const obj = {};
  normalizeCookie(str)
    .split(";")
    .forEach((p) => {
      const i = p.indexOf("=");
      if (i > 0) obj[p.slice(0, i).trim()] = p.slice(i + 1).trim();
    });
  return obj;
}

function getHeader(h, k) {
  const key = k.toLowerCase();
  for (const i in h) {
    if (i.toLowerCase() === key) return h[i];
  }
  return null;
}

function formatTime(t) {
  return (t || "")
    .replace("T", " ")
    .replace(/\..*$/, "")
    .replace(/\+\d\d:\d\d$/, "");
}

// ========= Env =========
function Env(name) {
  return {
    name,
    getdata: (k) => $persistentStore?.read(k),
    setdata: (v, k) => $persistentStore?.write(v, k),
    post: (o, c) => $httpClient?.post(o, c),
    get: (o, c) => $httpClient?.get(o, c),
    msg: (t, s, b) => {
      $notification?.post(t, s, b);
      console.log(`===${t}===\n${s}\n${b}`);
    },
    logErr: (e) => console.log(`â—ï¸${name}: ${e}`),
    done: () => $done?.({}),
  };
}