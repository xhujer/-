const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const KEY_FLOW = 'hdhive_points_flow_v1'; // ç¼“å­˜ç§¯åˆ†æµæ°´ï¼ˆå«ç­¾åˆ°è®°å½•ï¼‰
const DOMAIN = 'hdhive.com';

/** ===== é€šçŸ¥æ—¥å¿—ï¼ˆå¼€å…³ï¼‰===== */
const ENABLE_NOTIFY_LOG = true;  // true=é€šçŸ¥é™„å¸¦æ—¥å¿—ï¼›false=ä¸é™„å¸¦
const LOG_MAX_LINES = 12;
let LOGS = [];

function addLog(s) {
  if (!ENABLE_NOTIFY_LOG) return;
  const t = new Date().toLocaleString("zh-CN", { hour12: false });
  LOGS.push(`[${t}] ${s}`);
  if (LOGS.length > LOG_MAX_LINES) LOGS.shift();
}
function logsText() {
  if (!ENABLE_NOTIFY_LOG || !LOGS.length) return "";
  return `\n\nğŸ“‹ æ—¥å¿—:\n${LOGS.join("\n")}`;
}

(async () => {
  // http-responseï¼šæŠ“ç§¯åˆ†æµæ°´ï¼ˆéœ€è¦ Loon é…ç½® http-response + requires-body=trueï¼‰
  if (typeof $request !== "undefined" && typeof $response !== "undefined") {
    await captureFlowFromResponse();
  }
  // http-requestï¼šæŠ“ Cookie
  else if (typeof $request !== "undefined") {
    await capture();
  }
  // cronï¼šç­¾åˆ°
  else {
    await checkIn();
  }
})().catch((e) => $.logErr(e)).finally(() => $.done());

/** ===== æŠ“ Cookieï¼ˆhttp-requestï¼‰===== */
async function capture() {
  const url = $request.url || "";
  if (url.indexOf("user/checkin") > -1 || url.indexOf("/api/customer/user/checkin") > -1) return;
  if (url.indexOf(DOMAIN) === -1) return;

  const h = $request.headers || {};
  const cookie = (getHeader(h, 'Cookie') || "").trim();
  const ua = (getHeader(h, 'User-Agent') || "").trim();
  const referer = (getHeader(h, 'Referer') || "").trim();

  if (!cookie) return;

  addLog(`æ•è·è¯·æ±‚: ${url}`);

  // æ›´ç¨³ï¼štoken/csrf ä»»ä¸€å­˜åœ¨éƒ½ä¿å­˜
  const hasToken = cookie.includes("token=");
  const hasCsrf = cookie.includes("csrf_access_token=");
  if (!hasToken && !hasCsrf) return;

  if (cookie.length < 20) return;

  const oldCookie = $.getdata(KEY_COOKIE);
  if (cookie !== oldCookie) {
    $.setdata(cookie, KEY_COOKIE);
    if (ua) $.setdata(ua, KEY_UA);
    if (referer) $.setdata(referer, KEY_REFERER);
    addLog("Cookie/UA/Referer å·²æ›´æ–°");
    $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°");
  }
}

/** ===== æŠ“ç§¯åˆ†æµæ°´ï¼ˆhttp-responseï¼‰===== */
async function captureFlowFromResponse() {
  try {
    const url = $request.url || "";
    if (!url.includes(`${DOMAIN}/api/`)) return;

    const body = ($response && $response.body) ? $response.body : "";
    if (!body || body.length < 20) return;

    let j;
    try { j = JSON.parse(body); } catch (e) { return; }
    if (!j || typeof j !== "object") return;

    const flow = parsePointsFlow(j);
    if (!flow) return;

    $.setdata(JSON.stringify(flow), KEY_FLOW);
    addLog("å·²ç¼“å­˜ç§¯åˆ†æµæ°´ï¼ˆå«ç­¾åˆ°è®°å½•ï¼‰");
    $.msg("HDHive", "ğŸ“Œ å·²ç¼“å­˜ç­¾åˆ°è®°å½•", `æ¥æºæ¥å£ï¼š${url}`);
  } catch (e) {
    $.logErr(e);
  }
}

function formatTime(iso) {
  return (iso || "").replace("T", " ").replace(/\+\d\d:\d\d$/, "");
}

// å…¼å®¹ï¼špage1 å…¨ç­¾åˆ° / page2 æ·· admin_grant
function parsePointsFlow(resJson) {
  const list = resJson?.data?.list;
  if (!Array.isArray(list) || !list.length) return null;

  const latestCheckin = list.find(x => x && x.change_type === "ç­¾åˆ°") || null;
  if (!latestCheckin) return null;

  const recentCheckins = list
    .filter(x => x && x.change_type === "ç­¾åˆ°")
    .slice(0, 3)
    .map(x => `- ${formatTime(x.created_at)}ï¼š+${x.points}ï¼ˆ${x.remark || "ç­¾åˆ°"}ï¼‰`);

  return {
    user_id: latestCheckin.user_id,
    latest_checkin: {
      points: latestCheckin.points,
      time: latestCheckin.created_at,
      remark: latestCheckin.remark
    },
    recent_checkins: recentCheckins
  };
}

// ç²¾ç®€ï¼šåªæ˜¾ç¤ºç­¾åˆ°ï¼ˆä¸æ˜¾ç¤º admin_grantï¼‰
function buildFlowText(flow) {
  if (!flow) return "";

  const lines = [];
  lines.push(`ç”¨æˆ·IDï¼š${flow.user_id ?? "æœªçŸ¥"}`);
  lines.push(`æœ€è¿‘ç­¾åˆ°ï¼š${formatTime(flow.latest_checkin?.time) || "æœªçŸ¥"}`);
  if (flow.latest_checkin?.points != null) lines.push(`æœ¬æ¬¡è·å¾—ï¼š+${flow.latest_checkin.points} ç§¯åˆ†`);
  if (flow.latest_checkin?.remark) lines.push(`è¯´æ˜ï¼š${flow.latest_checkin.remark}`);

  if (flow.recent_checkins && flow.recent_checkins.length) {
    lines.push("");
    lines.push("æœ€è¿‘ç­¾åˆ°è®°å½•ï¼š");
    lines.push(flow.recent_checkins.join("\n"));
  }
  return lines.join("\n");
}

/** ===== ç­¾åˆ°ï¼ˆcronï¼‰===== */
async function checkIn() {
  LOGS = [];
  addLog("å¼€å§‹ç­¾åˆ°");

  const rawCookie = ($.getdata(KEY_COOKIE) || "").trim();
  const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
  const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

  if (!rawCookie) {
    addLog("æ— Cookie");
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
    return;
  }

  const cookieObj = parseCookie(rawCookie);
  const token = cookieObj['token'];
  const csrfToken = cookieObj['csrf_access_token'];

  if (!token) {
    addLog("ç¼ºå°‘token");
    $.msg("HDHive", "âŒ Cookieå¤±æ•ˆ", "ç¼ºå°‘tokenï¼Œè¯·é‡æ–°ç™»å½•");
    return;
  }

  const headers = {
    'User-Agent': ua,
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json',
    'Origin': `https://${DOMAIN}`,
    'Referer': referer,
    'Authorization': `Bearer ${token}`,
    'Cookie': rawCookie
  };
  if (csrfToken) headers['x-csrf-token'] = csrfToken;

  const req = {
    url: `https://${DOMAIN}/api/customer/user/checkin`,
    method: "POST",
    headers,
    body: ""
  };

  addLog(`è¯·æ±‚æ¥å£: ${req.url}`);

  return new Promise(resolve => {
    $.post(req, (err, resp, data) => {
      if (err || !resp) {
        addLog(`ç½‘ç»œé”™è¯¯: ${String(err)}`);
        $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿æ¥æœåŠ¡å™¨");
        resolve();
        return;
      }

      let resJson = {};
      try { resJson = JSON.parse(data); } catch (e) {}
      const msg = resJson.message || "";

      addLog(`HTTP: ${resp.status}`);
      addLog(`message: ${msg || "(ç©º)"}`);

      // è¯»å–ç¼“å­˜çš„ç­¾åˆ°è®°å½•
      let flow = null;
      try { flow = JSON.parse($.getdata(KEY_FLOW) || "null"); } catch(e) {}
      const flowText = flow ? ("\n\n" + buildFlowText(flow)) : "";

      // å…¼å®¹ï¼šå·²ç­¾åˆ°æ—¶å¯èƒ½ 400 æˆ–è€… success=false
      const looksChecked = msg.includes("å·²ç»ç­¾åˆ°") || msg.includes("æ˜å¤©å†æ¥") || msg.toLowerCase().includes("checked");

      if (resp.status === 200 || resp.status === 201) {
        $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", `${msg || "ç­¾åˆ°æˆåŠŸ"}${flowText}`);
      } else if (resp.status === 400) {
        if (looksChecked) {
          $.msg("HDHive", "ğŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", `${msg || "æ— éœ€é‡å¤æ‰§è¡Œ"}${flowText}`);
        } else {
          $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¼‚å¸¸", `${msg || "è¯·æ±‚å¼‚å¸¸"}${flowText}`);
        }
      } else if (resp.status === 401 || resp.status === 403) {
        $.msg("HDHive", "ğŸ”´ Cookieè¿‡æœŸ", "è¯·é‡æ–°ç™»å½•ç½‘é¡µ");
      } else {
        $.msg("HDHive", "âŒ æœªçŸ¥é”™è¯¯", `çŠ¶æ€ç  ${resp.status}${msg ? `ï¼š${msg}` : ""}`);
      }

      resolve();
    });
  });
}

function parseCookie(str) {
  const list = {};
  if (!str) return list;
  str.split(';').forEach(i => {
    const parts = i.split('=');
    if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
  });
  return list;
}

function getHeader(headers, key) {
  if (!headers) return null;
  const lowerKey = key.toLowerCase();
  for (const k in headers) {
    if (k.toLowerCase() === lowerKey) return headers[k];
  }
  return null;
}

function Env(name) {
  return {
    name,
    getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
    setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
    msg: (t, s, b) => {
      const body = `${b || ""}${logsText()}`; // è‡ªåŠ¨æŠŠæ—¥å¿—æ‹¼è¿›é€šçŸ¥
      if (typeof $notification !== "undefined") $notification.post(t, s, body);
      console.log(`===${t}===\n${s}\n${body}`);
    },
    post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
    logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
    done: () => typeof $done !== "undefined" ? $done({}) : null
  };
}