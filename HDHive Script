const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const DOMAIN = 'hdhive.com';

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

async function capture() {
    if ($request.url.indexOf("user/checkin") > -1) return;
    if ($request.url.indexOf(DOMAIN) === -1) return;

    const h = $request.headers;
    const cookie = getHeader(h, 'Cookie');
    const ua = getHeader(h, 'User-Agent');
    const referer = getHeader(h, 'Referer');

    if (cookie && cookie.indexOf("token=") > -1) {
        if (cookie.length < 20) return;
        const oldCookie = $.getdata(KEY_COOKIE);
        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (ua) $.setdata(ua, KEY_UA);
            if (referer) $.setdata(referer, KEY_REFERER);
            $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°");
        }
    }
}

async function checkIn() {
    const rawCookie = $.getdata(KEY_COOKIE);
    const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

    if (!rawCookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
        return;
    }

    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    const csrfToken = cookieObj['csrf_access_token'];

    if (!token) {
        $.msg("HDHive", "âŒ Cookieå¤±æ•ˆ", "ç¼ºå°‘tokenï¼Œè¯·é‡æ–°ç™»å½•");
        return;
    }

    const headers = {
        'User-Agent': ua,
        'Accept': 'application/json, text/plain, */*',
        'Origin': `https://${DOMAIN}`,
        'Referer': referer,
        'Authorization': `Bearer ${token}`,
        'Cookie': rawCookie
    };
    if (csrfToken) headers['x-csrf-token'] = csrfToken;

    const req = {
        url: `https://${DOMAIN}/api/customer/user/checkin`,
        method: "POST",
        headers: headers,
        body: ""
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿žæŽ¥æœåŠ¡å™¨");
                resolve();
                return;
            }
            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}
            const msg = resJson.message || "";
            
            if (resp.status === 200 || resp.status === 201) {
                $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
            } else if (resp.status === 400) {
                if (msg.includes("ç­¾åˆ°") || msg.includes("checked in")) {
                    $.msg("HDHive", "ðŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", "æ— éœ€é‡å¤æ‰§è¡Œ");
                } else {
                    $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¼‚å¸¸", msg);
                }
            } else if (resp.status === 401 || resp.status === 403) {
                $.msg("HDHive", "ðŸ”´ Cookieè¿‡æœŸ", "è¯·é‡æ–°ç™»å½•ç½‘é¡µ");
            } else {
                $.msg("HDHive", "âŒ æœªçŸ¥é”™è¯¯", `çŠ¶æ€ç  ${resp.status}`);
            }
            resolve();
        });
    });
}

function parseCookie(str) {
    const list = {};
    if (!str) return list;
    str.split(';').forEach(i => {
        const parts = i.split('=');
        if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
    });
    return list;
}

function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
