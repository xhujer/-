/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (v14.1 æŽ¥å£ä¿®æ­£ç‰ˆ)
 * ä¿®å¤ï¼šå°è¯•ä½¿ç”¨æ–°çš„ç”¨æˆ·ä¿¡æ¯æŽ¥å£ /api/customer/user
 * ä¼˜åŒ–ï¼šå¦‚æžœèŽ·å–ä¿¡æ¯å¤±è´¥ï¼Œä¸å†æŠ¥é”™ï¼Œè€Œæ˜¯é™çº§æ˜¾ç¤ºåŸºç¡€ç­¾åˆ°é€šçŸ¥
 */

const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v14'; 
const KEY_REFERER = 'hdhive_referer_v14'; 
const KEY_UA = 'hdhive_ua_v14';
const DOMAIN = 'hdhive.com';

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await main();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘
// ------------------------------------------
async function capture() {
    if ($request.url.indexOf("user/checkin") > -1) return;
    if ($request.url.indexOf(DOMAIN) === -1) return;

    const h = $request.headers;
    const cookie = getHeader(h, 'Cookie');
    const ua = getHeader(h, 'User-Agent');
    const referer = getHeader(h, 'Referer');

    if (cookie && cookie.indexOf("token=") > -1) {
        if (cookie.length < 20) return;
        const oldCookie = $.getdata(KEY_COOKIE);
        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (ua) $.setdata(ua, KEY_UA);
            if (referer) $.setdata(referer, KEY_REFERER);
            $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°");
        }
    }
}

// ------------------------------------------
// 2. ä¸»æµç¨‹
// ------------------------------------------
async function main() {
    const rawCookie = $.getdata(KEY_COOKIE);
    if (!rawCookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
        return;
    }

    // 1. ç­¾åˆ°
    const checkInRes = await doCheckIn(rawCookie);
    
    // 2. èŽ·å–è¯¦ç»†ä¿¡æ¯ (ä»…å½“å‡­è¯æœ‰æ•ˆæ—¶)
    let info = null;
    if (checkInRes.status !== 'expired') {
        info = await getUserInfo(rawCookie);
    }

    // 3. å‘é€é€šçŸ¥
    sendNotification(checkInRes, info);
}

// ------------------------------------------
// 3. ç­¾åˆ°è¯·æ±‚
// ------------------------------------------
async function doCheckIn(rawCookie) {
    const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";
    
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    const csrfToken = cookieObj['csrf_access_token'];

    if (!token) return { status: 'expired', msg: 'Cookieç¼ºå°‘token' };

    const headers = {
        'User-Agent': ua,
        'Accept': 'application/json, text/plain, */*',
        'Origin': `https://${DOMAIN}`,
        'Referer': referer,
        'Authorization': `Bearer ${token}`,
        'Cookie': rawCookie
    };
    if (csrfToken) headers['x-csrf-token'] = csrfToken;

    const req = {
        url: `https://${DOMAIN}/api/customer/user/checkin`,
        method: "POST",
        headers: headers,
        body: ""
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                resolve({ status: 'network', msg: 'ç½‘ç»œé”™è¯¯', earned: 0 });
                return;
            }
            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}
            const msg = resJson.message || "";
            const status = resp.status;

            let earned = 0;
            const match = msg.match(/èŽ·å¾—\s*(\d+)\s*ç§¯åˆ†/);
            if (match) earned = match[1];

            if (status === 200 || status === 201) {
                resolve({ status: 'success', msg: msg, earned: earned });
            } else if (status === 400) {
                if (msg.includes("ç­¾åˆ°") || msg.includes("checked in")) {
                    resolve({ status: 'repeat', msg: msg, earned: 0 });
                } else {
                    resolve({ status: 'fail', msg: msg, earned: 0 });
                }
            } else if (status === 401 || status === 403) {
                resolve({ status: 'expired', msg: 'å‡­è¯è¿‡æœŸ', earned: 0 });
            } else {
                resolve({ status: 'unknown', msg: `Code: ${status}`, earned: 0 });
            }
        });
    });
}

// ------------------------------------------
// 4. èŽ·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ (æŽ¥å£ä¿®æ­£)
// ------------------------------------------
async function getUserInfo(rawCookie) {
    const ua = $.getdata(KEY_UA);
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];

    // ã€ä¿®æ­£ç‚¹ã€‘å°è¯•åŽ»é™¤ /info åŽç¼€
    const req = {
        url: `https://${DOMAIN}/api/customer/user`,
        method: "GET",
        headers: {
            'User-Agent': ua,
            'Authorization': `Bearer ${token}`,
            'Cookie': rawCookie,
            'Accept': 'application/json'
        }
    };

    return new Promise(resolve => {
        $.get(req, (err, resp, data) => {
            // å¦‚æžœå‡ºé”™ï¼Œåªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹
            if (err || resp.status !== 200) {
                console.log(`[HDHive] èŽ·å–ä¿¡æ¯APIå¤±è´¥(Code ${resp ? resp.status : 'ERR'}): ${data}`);
                resolve(null);
                return;
            }
            try {
                const json = JSON.parse(data);
                const d = json.data || json; 

                // æ‰“å°æ•°æ®ç»“æž„ä»¥ä¾¿è°ƒè¯•
                // console.log(`[HDHive] UserData: ${JSON.stringify(d)}`);

                return resolve({
                    name: d.username || d.name || "æœªçŸ¥",
                    id: d.id || "æœªçŸ¥",
                    level: (d.group ? d.group.name : "") || d.level_name || "æ™®é€šç”¨æˆ·",
                    share: d.share_count || d.publish_count || d.uploads || 0,
                    integral: d.integral || d.points || d.balance || 0,
                    checkins: d.checkin_count || d.total_checkin || 0,
                    join: (d.created_at || d.join_time || "æœªçŸ¥").substring(0, 10)
                });
            } catch (e) {
                console.log(`[HDHive] è§£æžä¿¡æ¯é”™è¯¯: ${e}`);
                resolve(null);
            }
        });
    });
}

// ------------------------------------------
// 5. æ ¼å¼åŒ–é€šçŸ¥
// ------------------------------------------
function sendNotification(res, info) {
    let title = "HDHive ç­¾åˆ°æ—¥æŠ¥";
    let body = "";

    if (res.status === 'success') title = "âœ… HDHive ç­¾åˆ°æˆåŠŸ";
    else if (res.status === 'repeat') title = "ðŸŸ¢ HDHive ä»Šæ—¥å·²ç­¾";
    else if (res.status === 'expired') title = "ðŸ”´ HDHive å‡­è¯è¿‡æœŸ";
    else title = "âš ï¸ HDHive ç­¾åˆ°å¼‚å¸¸";

    // å¦‚æžœæˆåŠŸèŽ·å–åˆ°äº†ä¿¡æ¯ï¼Œæ˜¾ç¤ºè¯¦ç»†é¢æ¿
    if (info) {
        const earnedStr = res.earned > 0 ? ` (+${res.earned})` : "";
        
        body += `ç”¨æˆ·åç§°ï¼š${info.name}\n`;
        body += `ç”¨æˆ·lDï¼š${info.id}\n`;
        body += `ç”¨æˆ·ç­‰çº§ï¼š${info.level}\n`;
        body += `åˆ†äº«æ•°é‡ï¼š${info.share}\n`;
        body += `å½“å‰ç§¯åˆ†ï¼š${info.integral}${earnedStr}\n`;
        body += `ç´¯è®¡ç­¾åˆ°ï¼š${info.checkins}\n`;
        body += `åŠ å…¥æ—¶é—´ï¼š${info.join}`;
    } else {
        // é™çº§æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºç­¾åˆ°ç»“æžœï¼Œä¸æ˜¾ç¤ºæŠ¥é”™ä¿¡æ¯ï¼Œä¿æŒç¾Žè§‚
        body = `ç­¾åˆ°çŠ¶æ€ï¼š${res.msg}`;
        if (res.status === 'success' || res.status === 'repeat') {
            body += `\n(æš‚æ— æ³•èŽ·å–ç§¯åˆ†è¯¦æƒ…ï¼Œä½†ç­¾åˆ°å·²å®Œæˆ)`;
        }
    }

    $.msg(title, "", body);
}

// ------------------------------------------
// å·¥å…·å‡½æ•°
// ------------------------------------------
function parseCookie(str) {
    const list = {};
    if (!str) return list;
    str.split(';').forEach(i => {
        const parts = i.split('=');
        if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
    });
    return list;
}

function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        get: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.get(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
