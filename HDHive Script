const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const KEY_FLOW = 'hdhive_points_flow_v1'; // ç¼“å­˜ç­¾åˆ°è®°å½•ï¼ˆç§¯åˆ†æµæ°´ï¼‰
const DOMAIN = 'hdhive.com';

(async () => {
  // http-responseï¼šæŠ“ points-logs JSON
  if (typeof $request !== "undefined" && typeof $response !== "undefined") {
    await captureFlowFromResponse();
  }
  // http-requestï¼šæŠ“ Cookie
  else if (typeof $request !== "undefined") {
    await capture();
  }
  // cronï¼šç­¾åˆ°
  else {
    await checkIn();
  }
})().catch((e) => $.logErr(e)).finally(() => $.done());

async function capture() {
  const url = $request.url || "";
  if (url.indexOf("user/checkin") > -1 || url.indexOf("/api/customer/user/checkin") > -1) return;
  if (url.indexOf(DOMAIN) === -1) return;

  const h = $request.headers || {};
  const cookie = getHeader(h, 'Cookie');
  const ua = getHeader(h, 'User-Agent');
  const referer = getHeader(h, 'Referer');

  if (cookie && cookie.indexOf("token=") > -1) {
    if (cookie.length < 20) return;
    const oldCookie = $.getdata(KEY_COOKIE);
    if (cookie !== oldCookie) {
      $.setdata(cookie, KEY_COOKIE);
      if (ua) $.setdata(ua, KEY_UA);
      if (referer) $.setdata(referer, KEY_REFERER);
      $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°");
    }
  }
}

/** ========= æŠ“ points-logs JSONï¼ˆhttp-responseï¼‰ ========= */
async function captureFlowFromResponse() {
  try {
    const url = $request.url || "";

    // åªå¤„ç†è¿™ä¸ªæŽ¥å£ï¼ˆçº¯å‡€ï¼‰
    if (!url.includes("hdhive.com/go-api/customer/points-logs")) return;

    const ct = getHeader($response.headers || {}, "content-type") || "";
    if (!ct.toLowerCase().includes("application/json")) return;

    const body = $response.body || "";
    if (!body) return;

    let j;
    try { j = JSON.parse(body); } catch (e) { return; }

    const flow = parsePointsFlow(j);
    if (!flow) return;

    // åªè®© page=1ï¼ˆç¬¬ä¸€é¡µæœ€æ–°ï¼‰è¦†ç›–ç¼“å­˜ï¼›page>1 ä»…é¦–æ¬¡ç¼“å­˜æ—¶å†™å…¥
    cacheFlowPreferPage1($, KEY_FLOW, url, flow);

  } catch (e) {
    $.logErr(e);
  }
}

function getQueryParam(url, key) {
  const m = url.match(new RegExp(`[?&]${key}=([^&]+)`));
  return m ? decodeURIComponent(m[1]) : "";
}

function cacheFlowPreferPage1($, key, url, flowObj) {
  const pageStr = getQueryParam(url, "page") || "1";
  const page = parseInt(pageStr, 10);
  const hasOld = !!$.getdata(key);

  if (page === 1) {
    $.setdata(JSON.stringify(flowObj), key);
    // å¯é€‰ï¼šæƒ³å®‰é™å°±æ³¨é‡ŠæŽ‰ä¸‹ä¸€è¡Œ
    // $.msg("HDHive", "ðŸ“Œ å·²ç¼“å­˜ç­¾åˆ°è®°å½•", `å‘½ä¸­ page=1ï¼ˆæœ€æ–°ï¼‰`);
    return;
  }

  if (!hasOld) {
    $.setdata(JSON.stringify(flowObj), key);
    // å¯é€‰ï¼šæƒ³å®‰é™å°±æ³¨é‡ŠæŽ‰ä¸‹ä¸€è¡Œ
    // $.msg("HDHive", "ðŸ“Œ å·²ç¼“å­˜ç­¾åˆ°è®°å½•", `å‘½ä¸­ page=${page}ï¼ˆé¦–æ¬¡ç¼“å­˜ï¼‰`);
  }
}

function formatTime(iso) {
  return (iso || "").replace("T", " ").replace(/\+\d\d:\d\d$/, "");
}

// å…¼å®¹ page=1 å…¨ç­¾åˆ° / page=2 æ·· admin_grantï¼šæ°¸è¿œæ‰¾â€œæœ€è¿‘ä¸€æ¡ç­¾åˆ°â€
function parsePointsFlow(resJson) {
  const list = resJson?.data?.list;
  if (!resJson?.success || !Array.isArray(list) || !list.length) return null;

  const latestCheckin = list.find(x => x && x.change_type === "ç­¾åˆ°") || null;
  if (!latestCheckin) return null;

  const recentCheckins = list
    .filter(x => x && x.change_type === "ç­¾åˆ°")
    .slice(0, 3)
    .map(x => `- ${formatTime(x.created_at)}ï¼š+${x.points}ï¼ˆ${x.remark || "ç­¾åˆ°"}ï¼‰`);

  return {
    user_id: latestCheckin.user_id,
    latest_checkin: {
      points: latestCheckin.points,
      time: latestCheckin.created_at,
      remark: latestCheckin.remark
    },
    recent_checkins: recentCheckins
  };
}

function buildFlowText(flow) {
  if (!flow) return "";
  const lines = [];
  lines.push(`ç”¨æˆ·IDï¼š${flow.user_id ?? "æœªçŸ¥"}`);
  lines.push(`æœ€è¿‘ç­¾åˆ°ï¼š${formatTime(flow.latest_checkin?.time) || "æœªçŸ¥"}`);
  if (flow.latest_checkin?.points != null) lines.push(`æœ¬æ¬¡èŽ·å¾—ï¼š+${flow.latest_checkin.points} ç§¯åˆ†`);
  if (flow.latest_checkin?.remark) lines.push(`è¯´æ˜Žï¼š${flow.latest_checkin.remark}`);
  if (flow.recent_checkins?.length) {
    lines.push("");
    lines.push("æœ€è¿‘ç­¾åˆ°è®°å½•ï¼š");
    lines.push(flow.recent_checkins.join("\n"));
  }
  return lines.join("\n");
}

/** ========= ç­¾åˆ°ï¼ˆcronï¼‰ ========= */
async function checkIn() {
  const rawCookie = $.getdata(KEY_COOKIE);
  const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
  const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

  if (!rawCookie) {
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
    return;
  }

  const cookieObj = parseCookie(rawCookie);
  const token = cookieObj['token'];
  const csrfToken = cookieObj['csrf_access_token'];

  if (!token) {
    $.msg("HDHive", "âŒ Cookieå¤±æ•ˆ", "ç¼ºå°‘tokenï¼Œè¯·é‡æ–°ç™»å½•");
    return;
  }

  const headers = {
    'User-Agent': ua,
    'Accept': 'application/json, text/plain, */*',
    'Origin': `https://${DOMAIN}`,
    'Referer': referer,
    'Authorization': `Bearer ${token}`,
    'Cookie': rawCookie
  };
  if (csrfToken) headers['x-csrf-token'] = csrfToken;

  const req = {
    url: `https://${DOMAIN}/api/customer/user/checkin`,
    method: "POST",
    headers: headers,
    body: ""
  };

  // è¯»ç¼“å­˜çš„ç­¾åˆ°è®°å½•ï¼Œæ‹¼åˆ°é€šçŸ¥é‡Œ
  let flow = null;
  try { flow = JSON.parse($.getdata(KEY_FLOW) || "null"); } catch(e) {}
  const flowText = flow ? ("\n\n" + buildFlowText(flow)) : "";

  return new Promise(resolve => {
    $.post(req, (err, resp, data) => {
      if (err) {
        $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿žæŽ¥æœåŠ¡å™¨");
        resolve();
        return;
      }
      let resJson = {};
      try { resJson = JSON.parse(data); } catch (e) {}
      const msg = resJson.message || "";

      const looksChecked =
        msg.includes("å·²ç»ç­¾åˆ°") ||
        msg.includes("æ˜Žå¤©å†æ¥") ||
        msg.toLowerCase().includes("checked");

      if (resp.status === 200 || resp.status === 201) {
        $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", `${msg || "ç­¾åˆ°æˆåŠŸ"}${flowText}`);
      } else if (resp.status === 400) {
        if (looksChecked) {
          $.msg("HDHive", "ðŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", `${msg || "æ— éœ€é‡å¤æ‰§è¡Œ"}${flowText}`);
        } else {
          $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¼‚å¸¸", `${msg || "è¯·æ±‚å¼‚å¸¸"}${flowText}`);
        }
      } else if (resp.status === 401 || resp.status === 403) {
        $.msg("HDHive", "ðŸ”´ Cookieè¿‡æœŸ", "è¯·é‡æ–°ç™»å½•ç½‘é¡µ");
      } else {
        $.msg("HDHive", "âŒ æœªçŸ¥é”™è¯¯", `çŠ¶æ€ç  ${resp.status}${msg ? `ï¼š${msg}` : ""}`);
      }
      resolve();
    });
  });
}

function parseCookie(str) {
  const list = {};
  if (!str) return list;
  str.split(';').forEach(i => {
    const parts = i.split('=');
    if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
  });
  return list;
}

function getHeader(headers, key) {
  if (!headers) return null;
  const lowerKey = key.toLowerCase();
  for (const k in headers) {
    if (k.toLowerCase() === lowerKey) return headers[k];
  }
  return null;
}

function Env(name) {
  return {
    name: name,
    getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
    setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
    msg: (t, s, b) => {
      if (typeof $notification !== "undefined") $notification.post(t, s, b);
      console.log(`===${t}===\n${s}\n${b}`);
    },
    post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
    logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
    done: () => typeof $done !== "undefined" ? $done({}) : null
  };
}