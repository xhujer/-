/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (v15.0 æ··åˆæŠ€æœ¯ç‰ˆ)
 * æ ¸å¿ƒå‡çº§ï¼šAPI è·¯ä¸é€šï¼Œæ”¹èµ°é¡µé¢åˆ†æè·¯ã€‚
 * 1. æœ¬åœ°è§£ç  Token è·å–ç”¨æˆ· ID (100% æˆåŠŸ)
 * 2. æ¨¡æ‹Ÿè®¿é—® Dashboard é¡µé¢ï¼Œæ­£åˆ™æå–ç§¯åˆ†ã€ç­‰çº§ã€ç”¨æˆ·å
 */

const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v15'; // å‡çº§ Key
const KEY_REFERER = 'hdhive_referer_v15'; 
const KEY_UA = 'hdhive_ua_v15';
const DOMAIN = 'hdhive.com'; // é”å®šåŸŸå

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await main();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘
// ------------------------------------------
async function capture() {
    if ($request.url.indexOf("user/checkin") > -1) return;
    if ($request.url.indexOf(DOMAIN) === -1) return;

    const h = $request.headers;
    const cookie = getHeader(h, 'Cookie');
    const ua = getHeader(h, 'User-Agent');
    const referer = getHeader(h, 'Referer');

    if (cookie && cookie.indexOf("token=") > -1) {
        if (cookie.length < 20) return;
        const oldCookie = $.getdata(KEY_COOKIE);
        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (ua) $.setdata(ua, KEY_UA);
            if (referer) $.setdata(referer, KEY_REFERER);
            $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°ï¼Œå‡†å¤‡æ‰§è¡Œæ··åˆè§£æ");
        }
    }
}

// ------------------------------------------
// 2. ä¸»æµç¨‹
// ------------------------------------------
async function main() {
    const rawCookie = $.getdata(KEY_COOKIE);
    if (!rawCookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
        return;
    }

    // 1. ç­¾åˆ°
    const checkInRes = await doCheckIn(rawCookie);
    
    // 2. åªæœ‰å½“ Cookie æœ‰æ•ˆæ—¶ï¼Œæ‰å°è¯•è·å–è¯¦ç»†ä¿¡æ¯
    let info = null;
    if (checkInRes.status !== 'expired') {
        // ä½¿ç”¨æ··åˆæŠ€æœ¯è·å–ä¿¡æ¯ (JWT + é¡µé¢çˆ¬å–)
        info = await fetchUserInfoCombined(rawCookie);
    }

    // 3. å‘é€é€šçŸ¥
    sendNotification(checkInRes, info);
}

// ------------------------------------------
// 3. ç­¾åˆ°è¯·æ±‚
// ------------------------------------------
async function doCheckIn(rawCookie) {
    const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";
    
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    const csrfToken = cookieObj['csrf_access_token'];

    if (!token) return { status: 'expired', msg: 'Cookieç¼ºå°‘token' };

    const headers = {
        'User-Agent': ua,
        'Accept': 'application/json, text/plain, */*',
        'Origin': `https://${DOMAIN}`,
        'Referer': referer,
        'Authorization': `Bearer ${token}`,
        'Cookie': rawCookie
    };
    if (csrfToken) headers['x-csrf-token'] = csrfToken;

    const req = {
        url: `https://${DOMAIN}/api/customer/user/checkin`,
        method: "POST",
        headers: headers,
        body: ""
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                resolve({ status: 'network', msg: 'ç½‘ç»œé”™è¯¯', earned: 0 });
                return;
            }
            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}
            const msg = resJson.message || "";
            const status = resp.status;

            let earned = 0;
            const match = msg.match(/è·å¾—\s*(\d+)\s*ç§¯åˆ†/);
            if (match) earned = match[1];

            if (status === 200 || status === 201) {
                resolve({ status: 'success', msg: msg, earned: earned });
            } else if (status === 400) {
                if (msg.includes("ç­¾åˆ°") || msg.includes("checked in")) {
                    resolve({ status: 'repeat', msg: msg, earned: 0 });
                } else {
                    resolve({ status: 'fail', msg: msg, earned: 0 });
                }
            } else if (status === 401 || status === 403) {
                resolve({ status: 'expired', msg: 'å‡­è¯è¿‡æœŸ', earned: 0 });
            } else {
                resolve({ status: 'unknown', msg: `Code: ${status}`, earned: 0 });
            }
        });
    });
}

// ------------------------------------------
// 4. æ··åˆè·å–ç”¨æˆ·ä¿¡æ¯ (JWT + HTML Scraping)
// ------------------------------------------
async function fetchUserInfoCombined(rawCookie) {
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    
    // 1. ã€é»‘ç§‘æŠ€ã€‘æœ¬åœ°è§£ç  JWT è·å– User ID
    // è¿™æ˜¯ä¸€ä¸ªæ— éœ€ç½‘ç»œè¯·æ±‚çš„å¿…æ€æŠ€
    let userId = "æœªçŸ¥";
    try {
        const payload = token.split('.')[1]; // å–ä¸­é—´éƒ¨åˆ†
        const decoded = JSON.parse(decodeBase64(payload));
        if (decoded && decoded.sub) userId = decoded.sub;
    } catch (e) {
        console.log(`[HDHive] JWTè§£ç å¤±è´¥: ${e}`);
    }

    // 2. ã€ç¬¨åŠæ³•ã€‘è®¿é—® Dashboard é¡µé¢å»æŠ  HTML
    const pageData = await scrapeDashboard(rawCookie);

    return {
        id: userId, // ä¼˜å…ˆç”¨ JWT è§£ç çš„ IDï¼Œæœ€å‡†
        name: pageData.name || "æœªçŸ¥",
        level: pageData.level || "æœªçŸ¥",
        integral: pageData.integral || "æœªçŸ¥",
        checkins: pageData.checkins || "æœªçŸ¥",
        share: pageData.share || "æœªçŸ¥",
        join: pageData.join || "æœªçŸ¥"
    };
}

// çˆ¬å– Dashboard é¡µé¢
async function scrapeDashboard(rawCookie) {
    const ua = $.getdata(KEY_UA);
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];

    const req = {
        // å°è¯•è®¿é—®ç”¨æˆ·ä¸»é¡µ/æ§åˆ¶å°
        url: `https://${DOMAIN}/user/dashboard`,
        method: "GET",
        headers: {
            'User-Agent': ua,
            'Authorization': `Bearer ${token}`, // å¸¦ä¸Š token é˜²è·³è½¬
            'Cookie': rawCookie,
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        }
    };

    return new Promise(resolve => {
        $.get(req, (err, resp, data) => {
            if (err || resp.status !== 200) {
                console.log(`[HDHive] é¡µé¢æŠ“å–å¤±è´¥: ${resp ? resp.status : err}`);
                resolve({});
                return;
            }

            // --- æ­£åˆ™å¤§ä¹±ç‚– ---
            // é’ˆå¯¹ HDHive çš„ HTML ç»“æ„è¿›è¡Œç›²çŒœåŒ¹é…
            // å¦‚æœæå–ä¸åˆ°ï¼Œè¯·å°†æ—¥å¿—å‘ç»™æˆ‘ï¼Œæˆ‘å†å¾®è°ƒæ­£åˆ™
            const result = {};

            // 1. ç§¯åˆ† (åŒ¹é… "ç§¯åˆ†" æˆ– "Integral" é™„è¿‘çš„æ•°å­—)
            // å¸¸è§ç»“æ„: <div>ç§¯åˆ†</div><div>1234</div>
            const integralMatch = data.match(/(?:ç§¯åˆ†|Integral)[\s\S]{0,50}?(\d{2,})/i) || data.match(/integral.*?value">(\d+)/i);
            if (integralMatch) result.integral = integralMatch[1];

            // 2. ç­‰çº§ (åŒ¹é… "ç­‰çº§" æˆ– "Level" é™„è¿‘çš„è¯)
            const levelMatch = data.match(/(?:ç­‰çº§|Level)[\s\S]{0,50}?class=".*?">([^<]+)</i) || data.match(/(?:ç­‰çº§|Level)\s*[:ï¼š]\s*(\S+)/);
            if (levelMatch) result.level = levelMatch[1].trim();

            // 3. ç”¨æˆ·å (é€šå¸¸åœ¨ title æˆ– æ¬¢è¿è¯­ä¸­)
            const nameMatch = data.match(/æ¬¢è¿|Welcome[\s\S]{0,20}?(\S+?)\s*</) || data.match(/class="username">([^<]+)</);
            if (nameMatch) result.name = nameMatch[1];

            // 4. ç­¾åˆ°å¤©æ•°
            const checkinMatch = data.match(/(?:ç­¾åˆ°|Check-in)[\s\S]{0,50}?(\d{1,5})/);
            if (checkinMatch) result.checkins = checkinMatch[1];
            
            // 5. åˆ†äº«ç‡/æ•°é‡
            const shareMatch = data.match(/(?:åˆ†äº«|Share)[\s\S]{0,50}?(\d+)/);
            if (shareMatch) result.share = shareMatch[1];

            resolve(result);
        });
    });
}

// ------------------------------------------
// 5. æ ¼å¼åŒ–é€šçŸ¥
// ------------------------------------------
function sendNotification(res, info) {
    let title = "HDHive ç­¾åˆ°æ—¥æŠ¥";
    let body = "";

    if (res.status === 'success') title = "âœ… HDHive ç­¾åˆ°æˆåŠŸ";
    else if (res.status === 'repeat') title = "ğŸŸ¢ HDHive ä»Šæ—¥å·²ç­¾";
    else if (res.status === 'expired') title = "ğŸ”´ HDHive å‡­è¯è¿‡æœŸ";
    else title = "âš ï¸ HDHive ç­¾åˆ°å¼‚å¸¸";

    // æ„é€ æ­£æ–‡
    if (info) {
        const earnedStr = res.earned > 0 ? ` (+${res.earned})` : "";
        
        body += `ç”¨æˆ·åç§°ï¼š${info.name}\n`;
        body += `ç”¨æˆ·lDï¼š${info.id}\n`; // è¿™ä¸ª ID æ˜¯ JWT è§£ç çš„ï¼Œç»å¯¹å‡†ç¡®
        body += `ç”¨æˆ·ç­‰çº§ï¼š${info.level}\n`;
        body += `åˆ†äº«æ•°é‡ï¼š${info.share}\n`;
        body += `å½“å‰ç§¯åˆ†ï¼š${info.integral}${earnedStr}\n`;
        body += `ç´¯è®¡ç­¾åˆ°ï¼š${info.checkins}\n`;
        // body += `åŠ å…¥æ—¶é—´ï¼š${info.join}`; // é¡µé¢ä¸Šå¾ˆéš¾æŠ“åˆ°åŠ å…¥æ—¶é—´ï¼Œå…ˆéšè—
    } else {
        body = `ç­¾åˆ°çŠ¶æ€ï¼š${res.msg}\n(æ•°æ®æŠ“å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘é¡µç»“æ„)`;
    }

    $.msg(title, "", body);
}

// ------------------------------------------
// å·¥å…·å‡½æ•°
// ------------------------------------------
function decodeBase64(str) {
    // ç®€å•çš„ Base64Url è§£ç 
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    while (str.length % 4) {
        str += '=';
    }
    return atob(str);
}

// atob Polyfill for Loon (å¦‚æœæ˜¯æ—§ç‰ˆæœ¬ç¯å¢ƒ)
function atob(input) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
    let str = input.replace(/=+$/, '');
    let output = '';
    if (str.length % 4 == 1) {
        throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");
    }
    for (let bc = 0, bs = 0, buffer, i = 0; buffer = str.charAt(i++); ~buffer && (bs = bc % 4 ? bs * 64 + buffer : buffer, bc++ % 4) ? output += String.fromCharCode(255 & bs >> (-2 * bc & 6)) : 0) {
        buffer = chars.indexOf(buffer);
    }
    return output;
}

function parseCookie(str) {
    const list = {};
    if (!str) return list;
    str.split(';').forEach(i => {
        const parts = i.split('=');
        if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
    });
    return list;
}

function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        get: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.get(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
