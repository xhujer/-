const $ = new Env("HDHive");

const KEY_COOKIE = 'hdhive_cookie_v12';
const KEY_REFERER = 'hdhive_referer_v12';
const KEY_UA = 'hdhive_ua_v12';
const KEY_PROFILE = 'hdhive_profile_cache_v1'; // ç¼“å­˜ç”¨æˆ·èµ„æ–™
const DOMAIN = 'hdhive.com';

/** ====== é€šçŸ¥æ—¥å¿—å¼€å…³ ====== */
const ENABLE_NOTIFY_LOG = true;     // true=é€šçŸ¥é‡Œå¸¦æ—¥å¿—ï¼›false=ä¸å¸¦
const LOG_MAX_LINES = 12;           // æœ€å¤šä¿ç•™æ—¥å¿—è¡Œæ•°
let LOGS = [];

function addLog(s) {
  if (!ENABLE_NOTIFY_LOG) return;
  const t = new Date().toLocaleString("zh-CN", { hour12: false });
  LOGS.push(`[${t}] ${s}`);
  if (LOGS.length > LOG_MAX_LINES) LOGS.shift();
}
function logsText() {
  if (!ENABLE_NOTIFY_LOG || !LOGS.length) return "";
  return `\n\nğŸ“‹ æ—¥å¿—:\n${LOGS.join("\n")}`;
}

(async () => {
  // å¤„ç† http-responseï¼šæŠ“èµ„æ–™
  if (typeof $request !== "undefined" && typeof $response !== "undefined") {
    await captureProfileFromResponse();
  }
  // å¤„ç† http-requestï¼šæŠ“ cookie
  else if (typeof $request !== "undefined") {
    await capture();
  }
  // å®šæ—¶ä»»åŠ¡ï¼šç­¾åˆ°
  else {
    await checkIn();
  }
})().catch((e) => $.logErr(e)).finally(() => $.done());

/** ====== æŠ“ Cookieï¼ˆhttp-requestï¼‰ ====== */
async function capture() {
  const url = $request.url || "";
  if (url.indexOf("user/checkin") > -1 || url.indexOf("/api/customer/user/checkin") > -1) return;
  if (url.indexOf(DOMAIN) === -1) return;

  const h = $request.headers || {};
  const cookie = (getHeader(h, 'Cookie') || "").trim();
  const ua = (getHeader(h, 'User-Agent') || "").trim();
  const referer = (getHeader(h, 'Referer') || "").trim();

  if (!cookie) return;

  addLog(`æ•è·è¯·æ±‚: ${url}`);
  addLog(`Cookieå­—æ®µå­˜åœ¨: ${cookie.length > 0 ? "æ˜¯" : "å¦"}`);

  // æ›´ç¨³ï¼štoken/csrf ä»»ä¸€å­˜åœ¨éƒ½ä¿å­˜ï¼ˆé¿å…ç«™ç‚¹æ”¹åæŠ“ä¸åˆ°ï¼‰
  const hasToken = cookie.includes("token=");
  const hasCsrf = cookie.includes("csrf_access_token=");
  if (!hasToken && !hasCsrf) return;

  if (cookie.length < 20) return;

  const oldCookie = $.getdata(KEY_COOKIE);
  if (cookie !== oldCookie) {
    $.setdata(cookie, KEY_COOKIE);
    if (ua) $.setdata(ua, KEY_UA);
    if (referer) $.setdata(referer, KEY_REFERER);
    addLog("Cookie/UA/Referer å·²å†™å…¥æŒä¹…åŒ–");
    $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "Cookieå·²æ›´æ–°");
  }
}

/** ====== æŠ“ç”¨æˆ·èµ„æ–™ï¼ˆhttp-responseï¼‰ ====== */
async function captureProfileFromResponse() {
  try {
    const url = $request.url || "";
    if (!url.includes(`${DOMAIN}/api/`)) return;

    const body = ($response && $response.body) ? $response.body : "";
    if (!body || body.length < 20) return;

    let j;
    try { j = JSON.parse(body); } catch (e) { return; }
    if (!j || typeof j !== "object") return;

    // å®½æ¾ç‰¹å¾åŒ¹é…ï¼šå‘½ä¸­>=2ä¸ªå…³é”®å­—æ®µå°±è®¤ä¸ºæ˜¯â€œèµ„æ–™ç±»JSONâ€
    const s = body;
    let hit = 0;
    if (s.includes("username") || s.includes("\"name\"")) hit++;
    if (s.includes("userId") || s.includes("\"id\"")) hit++;
    if (s.includes("level")) hit++;
    if (s.includes("points") || s.includes("score")) hit++;
    if (s.includes("checkin")) hit++;
    if (s.includes("join") || s.includes("created_at")) hit++;

    if (hit < 2) return;

    const profile = j.user || j.data?.user || j.data?.profile || j.profile || j.data || j;
    $.setdata(JSON.stringify(profile), KEY_PROFILE);

    addLog(`å·²ç¼“å­˜ç”¨æˆ·èµ„æ–™ï¼Œå‘½ä¸­å­—æ®µæ•°=${hit}`);
    $.msg("HDHive", "ğŸ“Œ å·²ç¼“å­˜ç”¨æˆ·èµ„æ–™", `æ¥æºæ¥å£ï¼š${url}`);
  } catch (e) {
    $.logErr(e);
  }
}

/** ====== ç­¾åˆ°ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ ====== */
async function checkIn() {
  LOGS = []; // æ¯æ¬¡ç­¾åˆ°æ¸…ç©ºæ—¥å¿—ï¼Œé¿å…ä¸Šæ¬¡æ®‹ç•™
  addLog("å¼€å§‹ç­¾åˆ°");

  const rawCookie = ($.getdata(KEY_COOKIE) || "").trim();
  const referer = $.getdata(KEY_REFERER) || `https://${DOMAIN}/`;
  const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

  if (!rawCookie) {
    addLog("æœªæ‰¾åˆ°Cookie");
    $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", `æ— Cookieï¼Œè¯·è®¿é—® ${DOMAIN}`);
    return;
  }

  const cookieObj = parseCookie(rawCookie);
  const token = cookieObj['token'];
  const csrfToken = cookieObj['csrf_access_token'];

  addLog(`tokenå­˜åœ¨: ${token ? "æ˜¯" : "å¦"}`);
  addLog(`csrfå­˜åœ¨: ${csrfToken ? "æ˜¯" : "å¦"}`);

  if (!token) {
    $.msg("HDHive", "âŒ Cookieå¤±æ•ˆ", "ç¼ºå°‘tokenï¼Œè¯·é‡æ–°ç™»å½•");
    return;
  }

  const headers = {
    'User-Agent': ua,
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json',
    'Origin': `https://${DOMAIN}`,
    'Referer': referer,
    'Authorization': `Bearer ${token}`,
    'Cookie': rawCookie
  };
  if (csrfToken) headers['x-csrf-token'] = csrfToken;

  const req = {
    url: `https://${DOMAIN}/api/customer/user/checkin`,
    method: "POST",
    headers,
    body: "" // å¦‚æœé‡åˆ°åç«¯ä¸æ¥å—ç©ºbodyï¼Œå¯æ”¹æˆ "{}"
  };

  addLog(`è¯·æ±‚æ¥å£: ${req.url}`);

  return new Promise(resolve => {
    $.post(req, (err, resp, data) => {
      if (err || !resp) {
        addLog(`ç½‘ç»œé”™è¯¯: ${String(err)}`);
        $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿æ¥æœåŠ¡å™¨");
        resolve();
        return;
      }

      addLog(`HTTPçŠ¶æ€ç : ${resp.status}`);

      let resJson = {};
      try { resJson = JSON.parse(data); } catch (e) {}
      const msg = resJson.message || "";
      addLog(`è¿”å›message: ${msg || "(ç©º)"}`);

      // ä»ç¼“å­˜æ‹¿èµ„æ–™ï¼ˆå› ä¸ºå·²ç­¾åˆ°æ—¶æ¥å£åªå›message/successï¼‰
      let cached = {};
      try { cached = JSON.parse($.getdata(KEY_PROFILE) || "{}"); } catch(e) {}
      const profileText = (cached && Object.keys(cached).length)
        ? ("\n\n" + buildProfileText(cached))
        : "";

      // success=false ä¸” message åƒâ€œå·²ç­¾åˆ°â€ï¼Œä¹ŸæŒ‰å·²ç­¾åˆ°å¤„ç†
      const success = (typeof resJson.success === "boolean") ? resJson.success : null;
      const looksChecked = msg.includes("å·²ç»ç­¾åˆ°") || msg.toLowerCase().includes("checked");

      if (resp.status === 200 || resp.status === 201) {
        $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", `${msg || "ç­¾åˆ°æˆåŠŸ"}${profileText}`);
      } else if (resp.status === 400) {
        if (looksChecked) {
          $.msg("HDHive", "ğŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", `${msg || "æ— éœ€é‡å¤æ‰§è¡Œ"}${profileText}`);
        } else {
          $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¼‚å¸¸", `${msg || "æœªçŸ¥400é”™è¯¯"}${profileText}`);
        }
      } else if (resp.status === 401 || resp.status === 403) {
        $.msg("HDHive", "ğŸ”´ Cookieè¿‡æœŸ", "è¯·é‡æ–°ç™»å½•ç½‘é¡µ");
      } else {
        $.msg("HDHive", "âŒ æœªçŸ¥é”™è¯¯", `çŠ¶æ€ç  ${resp.status}${msg ? `ï¼š${msg}` : ""}`);
      }

      resolve();
    });
  });
}

/** ====== å·¥å…·ï¼šæŠŠç¼“å­˜èµ„æ–™æ ¼å¼åŒ–æˆä½ æƒ³è¦çš„æ ·å¼ ====== */
function buildProfileText(p = {}) {
  // å…¼å®¹ä¸åŒå­—æ®µåï¼ˆæŒ‰ä½ å®é™…ç¼“å­˜åˆ°çš„JSONå­—æ®µè‡ªåŠ¨åŒ¹é…ï¼‰
  const name = p.username || p.user_name || p.name || "æœªçŸ¥";
  const id = p.userId || p.user_id || p.id || "æœªçŸ¥";
  const level = p.level || p.user_level || p.role || "æœªçŸ¥";
  const share = p.shareCount ?? p.share_count ?? p.share ?? "æœªçŸ¥";
  const points = p.points ?? p.score ?? p.credit ?? "æœªçŸ¥";
  const totalCheckin = p.totalCheckin ?? p.total_checkin ?? p.checkin_total ?? "æœªçŸ¥";
  const joinAt = p.joinAt || p.join_time || p.created_at || "æœªçŸ¥";

  return [
    `ç”¨æˆ·åç§°ï¼š${name}`,
    `ç”¨æˆ·IDï¼š${id}`,
    `ç”¨æˆ·ç­‰çº§ï¼š${level}`,
    `åˆ†äº«æ•°é‡ï¼š${share}`,
    `å½“å‰ç§¯åˆ†ï¼š${points}`,
    `ç´¯è®¡ç­¾åˆ°ï¼š${totalCheckin}`,
    `åŠ å…¥æ—¶é—´ï¼š${joinAt}`,
  ].join("\n");
}

function parseCookie(str) {
  const list = {};
  if (!str) return list;
  str.split(';').forEach(i => {
    const parts = i.split('=');
    if (parts.length >= 2) list[parts[0].trim()] = parts.slice(1).join('=').trim();
  });
  return list;
}

function getHeader(headers, key) {
  if (!headers) return null;
  const lowerKey = key.toLowerCase();
  for (const k in headers) {
    if (k.toLowerCase() === lowerKey) return headers[k];
  }
  return null;
}

function Env(name) {
  return {
    name,
    getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
    setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
    msg: (t, s, b) => {
      const body = `${b || ""}${logsText()}`; // é€šçŸ¥é‡Œè‡ªåŠ¨è¿½åŠ æ—¥å¿—
      if (typeof $notification !== "undefined") $notification.post(t, s, body);
      console.log(`===${t}===\n${s}\n${body}`);
    },
    post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
    logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
    done: () => typeof $done !== "undefined" ? $done({}) : null
  };
}