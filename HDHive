/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (v7.0 åŠ¨æ€ CSRF ç‰ˆ)
 * æ ¸å¿ƒå‡çº§ï¼šä¸å†ä¾èµ–å­˜å‚¨çš„æ­» CSRFï¼Œè€Œæ˜¯æ¯æ¬¡ç­¾åˆ°å‰â€œç°åœºè·å–â€æœ€æ–° CSRFã€‚
 * æ•ˆæœï¼šå½»åº•è§£å†³ 419/Token è¿‡æœŸé—®é¢˜ï¼Œåªè¦ Cookie æ´»ç€å°±èƒ½ç­¾åˆ°ã€‚
 */

const $ = new Env("HDHive");

// é…ç½®
const CFG = {
    // 1. ç­¾åˆ°æ¥å£
    checkinUrl: 'https://hdhive.com/api/customer/user/checkin',
    // 2. ç”¨äºæå– CSRF çš„é¡µé¢ (é€šå¸¸æ˜¯ Dashboard æˆ–é¦–é¡µ)
    csrfUrl: 'https://hdhive.com/user/dashboard',
    
    origin: 'https://hdhive.com',
    referer: 'https://hdhive.com/user/dashboard'
};

// å­˜å‚¨ Key (åªéœ€è¦ Cookie å’Œ UAï¼Œä¸å†å¼ºä¾èµ–å­˜æ­»çš„ CSRF)
const KEY_COOKIE = 'hdhive_cookie_v7';
const KEY_UA = 'hdhive_ua_v7';

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await checkInLogic();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘ (ä¸»è¦æŠ“ Cookie)
// ------------------------------------------
async function capture() {
    if ($request.url.indexOf("user/checkin") > -1) return;

    const cookie = getHeader($request.headers, 'Cookie');
    const ua = getHeader($request.headers, 'User-Agent');

    if (cookie) {
        // ç®€å•æ ¡éªŒ
        if (cookie.length < 20) return;

        const oldCookie = $.getdata(KEY_COOKIE);

        // åªè¦ Cookie å˜äº†å°±å­˜
        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (ua) $.setdata(ua, KEY_UA);
            
            console.log(`[HDHive] æ•è· Cookie: ${cookie.substring(0, 15)}...`);
            $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "Cookie å·²ä¿å­˜ï¼ŒCSRF å°†ç”±è„šæœ¬è‡ªåŠ¨å¤„ç†");
        }
    }
}

// ------------------------------------------
// 2. ç­¾åˆ°ä¸»æµç¨‹
// ------------------------------------------
async function checkInLogic() {
    const cookie = $.getdata(KEY_COOKIE);
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

    if (!cookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æ—  Cookieï¼Œè¯·å…ˆç”¨æµè§ˆå™¨ç™»å½•å¹¶å‹¾é€‰[è®°ä½æˆ‘]");
        return;
    }

    // ç¬¬ä¸€æ­¥ï¼šè®¿é—®é¡µé¢ï¼ŒåŠ¨æ€æå–æœ€æ–°çš„ CSRF
    console.log("[HDHive] æ­£åœ¨åŠ¨æ€è·å–æ–°é²œ CSRF...");
    const freshCsrf = await getFreshCsrf(cookie, ua);

    if (!freshCsrf) {
        $.msg("HDHive", "âš ï¸ é¢„å¤„ç†å¤±è´¥", "Cookie å¯èƒ½å·²å¤±æ•ˆï¼Œæ— æ³•è·å– CSRF");
        return;
    }

    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨æ–°é²œçš„ CSRF è¿›è¡Œç­¾åˆ°
    await doCheckIn(cookie, freshCsrf, ua);
}

// ------------------------------------------
// 3. åŠ¨æ€è·å– CSRF (æ ¸å¿ƒé»‘ç§‘æŠ€)
// ------------------------------------------
async function getFreshCsrf(cookie, ua) {
    return new Promise(resolve => {
        const req = {
            url: CFG.csrfUrl,
            method: "GET",
            headers: {
                "Cookie": cookie,
                "User-Agent": ua,
                "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
            }
        };

        $.get(req, (err, resp, data) => {
            if (err || resp.status !== 200) {
                console.log(`[HDHive] è·å– CSRF å¤±è´¥ï¼ŒçŠ¶æ€ç : ${resp ? resp.status : 'Error'}`);
                resolve(null);
                return;
            }

            // ä½¿ç”¨æ­£åˆ™ä» HTML ä¸­æå– <meta name="csrf-token" content="...">
            // å¸¸è§çš„ Laravel å†™æ³•
            const metaPattern = /<meta\s+name=["']csrf-token["']\s+content=["'](.*?)["']/;
            const match = data.match(metaPattern);

            if (match && match[1]) {
                const token = match[1];
                console.log(`[HDHive] æˆåŠŸæå– CSRF: ${token.substring(0, 10)}...`);
                resolve(token);
            } else {
                console.log("[HDHive] é¡µé¢ä¸­æœªæ‰¾åˆ° csrf-token meta æ ‡ç­¾");
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæœ‰æ—¶å€™ token åœ¨ window.Laravel = { csrfToken: '...' }
                const jsPattern = /csrfToken\s*:\s*["'](.*?)["']/;
                const matchJs = data.match(jsPattern);
                if (matchJs && matchJs[1]) {
                    console.log(`[HDHive] ä» JS ä¸­æå– CSRF æˆåŠŸ`);
                    resolve(matchJs[1]);
                } else {
                    resolve(null);
                }
            }
        });
    });
}

// ------------------------------------------
// 4. æ‰§è¡Œç­¾åˆ°è¯·æ±‚
// ------------------------------------------
async function doCheckIn(cookie, csrf, ua) {
    const req = {
        url: CFG.checkinUrl,
        method: "POST",
        headers: {
            "Accept": "application/json, text/plain, */*",
            "X-Csrf-Token": csrf, // ä½¿ç”¨åˆšæå–çš„æ–°é²œ Token
            "Origin": CFG.origin,
            "Referer": CFG.referer,
            "Cookie": cookie,
            "User-Agent": ua
        },
        body: "" 
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥");
                resolve();
                return;
            }

            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}

            console.log(`[HDHive] ç­¾åˆ°çŠ¶æ€ç : ${resp.status}`);

            if (resp.status === 200 || resp.status === 201) {
                const msg = resJson.message || "ç­¾åˆ°æˆåŠŸ";
                $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
                console.log(`[HDHive] Success: ${data}`);
            } else if (resp.status === 400) {
                const msg = resJson.message || "è¯·æ±‚è¢«æ‹’ç»";
                if (msg.includes("å·²ç­¾åˆ°") || msg.includes("checked in")) {
                    $.msg("HDHive", "ğŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", msg);
                } else {
                    $.msg("HDHive", "âš ï¸ ç­¾åˆ°ç»“æœ(400)", msg);
                }
            } else if (resp.status === 419) {
                // å¦‚æœè¿™é‡Œè¿˜æŠ¥ 419ï¼Œè¯´æ˜ Cookie æœ¬èº«ä¹ŸåºŸäº†
                $.msg("HDHive", "âš ï¸ å½»åº•å¤±æ•ˆ", "Cookie å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            } else {
                $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", `çŠ¶æ€ç  ${resp.status}`);
            }
            resolve();
        });
    });
}

// ------------------------------------------
// è¾…åŠ©å‡½æ•°
// ------------------------------------------
function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        get: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.get(o, c) : null,
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
