/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (çº¯ Cookie ç‰ˆ v5.0)
 * ç­–ç•¥ï¼šå®Œå…¨æŠ›å¼ƒ Tokenï¼Œåªä½¿ç”¨ Cookie + CSRF è¿›è¡ŒéªŒè¯
 * ä¼˜åŠ¿ï¼šé…åˆæµè§ˆå™¨çš„â€œè®°ä½æˆ‘â€åŠŸèƒ½ï¼Œæœ‰æ•ˆæœŸæé•¿
 */

const $ = new Env("HDHive");

// é…ç½®
const CFG = {
    apiCheckin: 'https://hdhive.com/api/customer/user/checkin',
};

// å­˜å‚¨ Key (ä½¿ç”¨æ–° Key é˜²æ­¢æ—§æ•°æ®å¹²æ‰°)
const KEY_COOKIE = 'hdhive_cookie_v5';
const KEY_CSRF = 'hdhive_csrf_v5';

(async () => {
    if (typeof $request !== "undefined") {
        await captureCookie();
    } else {
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘ (åªæŠ“ Cookie + CSRF)
// ------------------------------------------
async function captureCookie() {
    const url = $request.url;
    // æ’é™¤ç­¾åˆ°æ¥å£æœ¬èº«
    if (url.indexOf("user/checkin") > -1) return;

    const h = $request.headers;
    
    // å¿…é¡»åŒæ—¶å­˜åœ¨ Cookie å’Œ CSRF æ‰æ˜¯æœ‰æ•ˆçš„ç”¨æˆ·è¯·æ±‚
    // (é™æ€èµ„æºé€šå¸¸æ²¡æœ‰ CSRF å¤´)
    const cookie = h['Cookie'] || h['cookie'];
    const csrf = h['x-csrf-token'] || h['X-Csrf-Token'];
    const userAgent = h['User-Agent'] || h['user-agent'];

    if (cookie && csrf) {
        // ç®€å•è¿‡æ»¤ï¼šCookie é•¿åº¦å¤ªçŸ­é€šå¸¸æ— æ•ˆ
        if (cookie.length < 20) return;

        const oldCookie = $.getdata(KEY_COOKIE);
        const oldCsrf = $.getdata(KEY_CSRF);

        if (cookie !== oldCookie || csrf !== oldCsrf) {
            $.setdata(cookie, KEY_COOKIE);
            $.setdata(csrf, KEY_CSRF);
            
            // é¡ºä¾¿æŠŠ UA ä¹Ÿå­˜ä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿå¾—æ›´åƒ
            if (userAgent) $.setdata(userAgent, 'hdhive_ua_v5');

            console.log(`[HDHive] æ•è·æ–° Cookie (å‰20ä½): ${cookie.substring(0, 20)}...`);
            $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "Cookie å·²æ›´æ–°ï¼Œè¯·æµ‹è¯•è¿è¡Œ");
        }
    }
}

// ------------------------------------------
// 2. ç­¾åˆ°é€»è¾‘ (çº¯ Cookie å‘åŒ…)
// ------------------------------------------
async function checkIn() {
    const cookie = $.getdata(KEY_COOKIE);
    const csrf = $.getdata(KEY_CSRF);
    const ua = $.getdata('hdhive_ua_v5') || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

    if (!cookie || !csrf) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æ—  Cookieï¼Œè¯·ç”¨æµè§ˆå™¨ç™»å½• hdhive.com å¹¶å‹¾é€‰[è®°ä½æˆ‘]");
        return;
    }

    const req = {
        url: CFG.apiCheckin,
        method: "POST",
        headers: {
            "accept": "application/json, text/plain, */*",
            "x-csrf-token": csrf,
            "origin": "https://hdhive.com",
            "referer": "https://hdhive.com/user/dashboard",
            "cookie": cookie,     // æ ¸å¿ƒå‡­è¯
            "user-agent": ua      // æ¨¡æ‹Ÿæ¥æº
            // æ³¨æ„ï¼šè¿™é‡Œç»å¯¹ä¸èƒ½åŠ  Authorization å¤´
        },
        body: "" // ä¿æŒç©º Bodyï¼Œç¬¦åˆ UserScript é€»è¾‘
    };

    return new Promise((resolve) => {
        $.post(req, (err, resp, data) => {
            if (err) {
                $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥");
                console.log(err);
                resolve();
                return;
            }

            // è§£æå“åº”
            let isJson = false;
            let resJson = {};
            try {
                resJson = JSON.parse(data);
                isJson = true;
            } catch (e) {}

            console.log(`[HDHive] çŠ¶æ€ç : ${resp.status}`);

            if (resp.status === 200 || resp.status === 201) {
                const msg = (isJson && resJson.message) ? resJson.message : "ç­¾åˆ°æˆåŠŸ";
                $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
                console.log(`[HDHive] Success: ${data}`);
            } else {
                if (resp.status === 401 || resp.status === 419) {
                    // 419 æ˜¯ Laravel ç‰¹æœ‰çš„ CSRF è¿‡æœŸé”™è¯¯
                    $.msg("HDHive", "âš ï¸ ä¼šè¯å¤±æ•ˆ", "Cookie/CSRF å·²è¿‡æœŸï¼Œè¯·é‡æ–°åˆ·æ–°ç½‘é¡µ");
                } else if (resp.status === 400) {
                    const msg = (isJson && resJson.message) ? resJson.message : "è¯·æ±‚è¢«æ‹’ç»(400)";
                    $.msg("HDHive", "âš ï¸ ç­¾åˆ°ç»“æœ", msg);
                } else {
                    $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", `çŠ¶æ€ç  ${resp.status}`);
                }
            }
            resolve();
        });
    });
}

// ------------------------------------------
// å·¥å…·ç±»
// ------------------------------------------
function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
