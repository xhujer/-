/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (å¤åˆ»æ²¹çŒ´ç‰ˆ v2.2)
 * åŸºäºŽç”¨æˆ·æä¾›çš„ UserScript é€»è¾‘é‡å†™
 * 1. æŠ“å–é€»è¾‘åŒæ­¥ï¼šç›‘æŽ§ /api/ ä¸‹çš„æ‰€æœ‰è¯·æ±‚
 * 2. Tokenå¤„ç†åŒæ­¥ï¼šç¡®ä¿å­˜å‚¨å’Œä½¿ç”¨æ—¶æ ¼å¼æ­£ç¡®
 * 3. ä¿®å¤ 400 é”™è¯¯ï¼šæ¨¡æ‹Ÿæ²¹çŒ´çš„è¯·æ±‚ä½“æ ¼å¼
 */

const $ = new Env("HDHive");

// --- é…ç½®åŒºåŸŸ (å¤åˆ» UserScript) ---
const CFG = {
    apiCheckin: 'https://hdhive.com/api/customer/user/checkin',
    // ç›‘å¬æ‰€æœ‰ /api/ è¯·æ±‚ï¼Œå’Œæ²¹çŒ´è„šæœ¬ä¿æŒä¸€è‡´
    watchApiPrefix: '/api/', 
};

const KEY_TOKEN = 'hdhive_token';
const KEY_CSRF = 'hdhive_csrf';

// --- å…¥å£ ---
(async () => {
    if (typeof $request !== "undefined") {
        await captureToken();
    } else {
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// --- æ ¸å¿ƒé€»è¾‘ 1: æŠ“å– (Capture) ---
async function captureToken() {
    const url = $request.url;
    
    // è¿‡æ»¤æŽ‰ç­¾åˆ°æŽ¥å£æœ¬èº«ï¼Œé˜²æ­¢æ­»å¾ªçŽ¯
    if (url.indexOf("user/checkin") > -1) return;

    const h = $request.headers;
    // å…¼å®¹å¤§å°å†™
    const auth = h['Authorization'] || h['authorization'];
    const csrf = h['x-csrf-token'] || h['X-Csrf-Token'];

    if (auth && csrf) {
        // æ²¹çŒ´é€»è¾‘ï¼šstripBearer (åŽ»æŽ‰Bearerå‰ç¼€)
        // Looné€»è¾‘ï¼šä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æŽ¥å­˜å®Œæ•´çš„ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ä¼šæ£€æŸ¥
        const storedAuth = $.getdata(KEY_TOKEN);
        
        if (auth !== storedAuth) {
            $.setdata(auth, KEY_TOKEN);
            $.setdata(csrf, KEY_CSRF);
            
            // æ‰“å°æ—¥å¿—
            console.log(`[HDHive] æ•èŽ·æ–°å‡­è¯:\nURL: ${url}\nToken: ${auth.substring(0, 15)}...`);
            $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "å‡­è¯å·²æ›´æ–°ï¼Œè¯·ç­‰å¾…å®šæ—¶ç­¾åˆ°");
        }
    }
}

// --- æ ¸å¿ƒé€»è¾‘ 2: ç­¾åˆ° (Check-in) ---
async function checkIn() {
    let token = $.getdata(KEY_TOKEN);
    const csrf = $.getdata(KEY_CSRF);

    if (!token || !csrf) {
        $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", "æœªæ£€æµ‹åˆ°å‡­è¯ï¼Œè¯·å…ˆç”¨æµè§ˆå™¨è®¿é—® hdhive.com");
        return;
    }

    // [å…³é”®ä¿®æ­£] ç¡®ä¿ Token æ ¼å¼æ­£ç¡®
    // å¦‚æžœæŠ“åˆ°çš„ Token æ²¡æœ‰ Bearer å‰ç¼€ï¼Œæ‰‹åŠ¨åŠ ä¸Š (æ¨¡æ‹Ÿæ²¹çŒ´çš„ headers: { authorization: Bearer ${token} })
    if (!token.toLowerCase().startsWith("bearer ")) {
        token = "Bearer " + token;
    }

    // [å…³é”®ä¿®æ­£] æ¨¡æ‹Ÿæ²¹çŒ´çš„è¯·æ±‚é…ç½®
    // æ²¹çŒ´æºç : data: '' (ç©ºå­—ç¬¦ä¸²)
    // ä¹‹å‰çš„ Loon: body: "{}" (å¯èƒ½å¯¼è‡´ 400)
    const req = {
        url: CFG.apiCheckin,
        method: "POST",
        headers: {
            "accept": "application/json, text/plain, */*",
            "authorization": token,
            "x-csrf-token": csrf,
            "origin": "https://hdhive.com",
            "referer": "https://hdhive.com/user/dashboard",
            // æ˜¾å¼å£°æ˜Ž JSONï¼Œä»¥é˜²æœåŠ¡å™¨å¯¹ç©º body æ•æ„Ÿ
            "Content-Type": "application/json" 
        },
        // å°è¯•å‘é€ç©ºå¯¹è±¡ï¼Œç¬¦åˆå¤§å¤šæ•° API è§„èŒƒ
        body: "{}" 
    };

    $.post(req, (err, resp, data) => {
        if (err) {
            $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥");
            console.log(err);
            return;
        }

        console.log(`[HDHive] çŠ¶æ€ç : ${resp.status}`);
        console.log(`[HDHive] å“åº”ä½“: ${data}`);

        // æ²¹çŒ´é€»è¾‘: const ok = !!safeJson(res.responseText)
        // åªè¦èƒ½è§£æž JSON å°±ç®—æˆåŠŸ
        let isJson = false;
        let resJson = {};
        try {
            resJson = JSON.parse(data);
            isJson = true;
        } catch (e) {}

        if (resp.status === 200 || resp.status === 201) {
            const msg = (isJson && resJson.message) ? resJson.message : "ç­¾åˆ°æˆåŠŸ";
            $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
        } else {
            // å¤„ç†é”™è¯¯
            if (resp.status === 401 || resp.status === 403) {
                $.msg("HDHive", "âš ï¸ å‡­è¯å¤±æ•ˆ", "Token å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            } else if (resp.status === 400) {
                // å¦‚æžœè¿˜æ˜¯ 400ï¼Œè¯´æ˜Žå¯èƒ½å·²ç»ç­¾åˆ°äº†ï¼Œæˆ–è€… Body æ ¼å¼ä¾ç„¶æœ‰é—®é¢˜
                const msg = (isJson && resJson.message) ? resJson.message : "è¯·æ±‚è¢«æ‹’ç»";
                $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¤±è´¥ (400)", msg);
            } else {
                $.msg("HDHive", "âŒ å¼‚å¸¸", `Status: ${resp.status}`);
            }
        }
    });
}

// --- Env Helper ---
function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
