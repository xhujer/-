/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (1:1 ä¸¥æ ¼å¤åˆ»ç‰ˆ)
 * ä¸¥æ ¼æŒ‰ç…§ UserScript é€»è¾‘é‡å†™ï¼Œè§£å†³ 400 é—®é¢˜
 */

const $ = new Env("HDHive");

// --- 1. é…ç½®å¤åˆ» ---
const CFG = {
    apiCheckin: 'https://hdhive.com/api/customer/user/checkin',
    watchApiPrefix: '/api/', 
};

const KEY_TOKEN = 'hdhive_token';
const KEY_CSRF = 'hdhive_csrf';

(async () => {
    if (typeof $request !== "undefined") {
        await captureToken();
    } else {
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// --- 2. æŠ“å–é€»è¾‘ (å¤åˆ» stripBearer) ---
async function captureToken() {
    const url = $request.url;
    if (url.indexOf("user/checkin") > -1) return;

    const h = $request.headers;
    const auth = h['Authorization'] || h['authorization'];
    const csrf = h['x-csrf-token'] || h['X-Csrf-Token'];

    if (auth && csrf) {
        // [UserScripté€»è¾‘]ï¼šå­˜å…¥å‰åŽ»æŽ‰ Bearer
        const rawToken = auth.replace(/^Bearer\s+/i, '').trim();
        const rawCsrf = csrf.trim();

        const storedToken = $.getdata(KEY_TOKEN);
        
        if (rawToken !== storedToken) {
            $.setdata(rawToken, KEY_TOKEN);
            $.setdata(rawCsrf, KEY_CSRF);
            
            console.log(`[HDHive] æ•èŽ· Token: ${rawToken.substring(0, 10)}...`);
            $.msg("HDHive", "ðŸŽ‰ æŠ“å–æˆåŠŸ", "å‡­è¯å·²æ›´æ–°");
        }
    }
}

// --- 3. ç­¾åˆ°é€»è¾‘ (å¤åˆ» Request) ---
async function checkIn() {
    const token = $.getdata(KEY_TOKEN);
    const csrf = $.getdata(KEY_CSRF);

    if (!token || !csrf) {
        $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", "æ— å‡­è¯ï¼Œè¯·ç”¨æµè§ˆå™¨é‡æ–°ç™»å½• hdhive.com");
        return;
    }

    // [UserScripté€»è¾‘]ï¼šä½¿ç”¨æ—¶åŠ ä¸Š Bearer
    const finalToken = `Bearer ${token}`;

    const req = {
        url: CFG.apiCheckin,
        method: "POST",
        headers: {
            "accept": "application/json, text/plain, */*",
            "authorization": finalToken,
            "x-csrf-token": csrf,
            "origin": "https://hdhive.com",
            "referer": "https://hdhive.com/user/dashboard"
            // [å…³é”®ä¿®æ­£]: UserScript æ²¡æœ‰ Content-Typeï¼Œè¿™é‡Œä¹Ÿä¸åŠ ï¼
        },
        // [å…³é”®ä¿®æ­£]: UserScript å‘é€çš„æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¸æ˜¯ "{}"
        body: "" 
    };

    $.post(req, (err, resp, data) => {
        if (err) {
            $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿žæŽ¥");
            console.log(err);
            return;
        }

        console.log(`[HDHive] çŠ¶æ€ç : ${resp.status}`);
        
        // [UserScripté€»è¾‘]: åªè¦èƒ½è§£æžJSONå°±ç®—æˆåŠŸ
        let isJson = false;
        let resJson = {};
        try {
            resJson = JSON.parse(data);
            isJson = true;
        } catch (e) {}

        if (resp.status === 200 || resp.status === 201) {
            // å¦‚æžœè§£æžå‡º message å°±æ˜¾ç¤º messageï¼Œå¦åˆ™æ˜¾ç¤ºé€šç”¨æˆåŠŸ
            const msg = (isJson && resJson.message) ? resJson.message : "ç­¾åˆ°æˆåŠŸ";
            $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
        } else {
            // é”™è¯¯å¤„ç†
            if (resp.status === 401 || resp.status === 403) {
                $.msg("HDHive", "âš ï¸ å‡­è¯å¤±æ•ˆ", "è¯·é‡æ–°ç™»å½•ç½‘ç«™");
            } else {
                const errMsg = (isJson && resJson.message) ? resJson.message : `çŠ¶æ€ç  ${resp.status}`;
                $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", errMsg);
                console.log(`[HDHive] å“åº”ä½“: ${data}`);
            }
        }
    });
}

// --- Env å·¥å…·ç±» ---
function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
