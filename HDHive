/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (v10.0 Pythonå¤åˆ»ç‰ˆ)
 * é€»è¾‘æ¥æºï¼šåŸºäº MoviePilot hdhivesign.py v1.0.0
 * æ ¸å¿ƒç­–ç•¥ï¼š
 * 1. å…¼å®¹ hdhive.com å’Œ hdhive.online åŒåŸŸå
 * 2. ä» Cookie ä¸­ç²¾å‡†æå– token å’Œ csrf_access_token
 * 3. ä¸¥æ ¼æŒ‰ç…§ Python æ’ä»¶çš„é€»è¾‘æ„é€ è¯·æ±‚å¤´ (Bearer + CSRF)
 */

const $ = new Env("HDHive");

// å­˜å‚¨ Key
const KEY_COOKIE = 'hdhive_cookie_v10'; // å­˜å‚¨åŸå§‹ Cookie
const KEY_REFERER = 'hdhive_referer_v10'; // å­˜å‚¨çœŸå®æ¥æº
const KEY_UA = 'hdhive_ua_v10'; 

(async () => {
    if (typeof $request !== "undefined") {
        await capture();
    } else {
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------------
// 1. æŠ“å–é€»è¾‘
// ------------------------------------------
async function capture() {
    // è¿‡æ»¤æ‰ç­¾åˆ°æ¥å£è‡ªèº«
    if ($request.url.indexOf("user/checkin") > -1) return;

    const h = $request.headers;
    const cookie = getHeader(h, 'Cookie');
    const referer = getHeader(h, 'Referer');
    const ua = getHeader(h, 'User-Agent');

    // åªè¦æœ‰ Cookie ä¸”åŒ…å« token å­—æ®µå°±æŠ“å–
    if (cookie && cookie.indexOf("token=") > -1) {
        // ç®€å•æ ¡éªŒé•¿åº¦
        if (cookie.length < 20) return;

        const oldCookie = $.getdata(KEY_COOKIE);

        if (cookie !== oldCookie) {
            $.setdata(cookie, KEY_COOKIE);
            if (referer) $.setdata(referer, KEY_REFERER);
            if (ua) $.setdata(ua, KEY_UA);
            
            // æå–åŸŸåç”¨äºæ—¥å¿—æ˜¾ç¤º
            const domain = $request.url.match(/https?:\/\/([^/]+)/)[1];
            console.log(`[HDHive] æ•è·å‡­è¯æˆåŠŸ (åŸŸå: ${domain})`);
            $.msg("HDHive", "ğŸ‰ æŠ“å–æˆåŠŸ", "å·²æå– Token å’Œ CSRFï¼Œå‡†å¤‡å°±ç»ª");
        }
    }
}

// ------------------------------------------
// 2. ç­¾åˆ°é€»è¾‘ (å¤åˆ» Python _signin_base)
// ------------------------------------------
async function checkIn() {
    const rawCookie = $.getdata(KEY_COOKIE);
    // å¦‚æœæ²¡æœ‰ Refererï¼Œé»˜è®¤ä½¿ç”¨ python è„šæœ¬ä¸­çš„é»˜è®¤å€¼
    const referer = $.getdata(KEY_REFERER) || "https://hdhive.online/";
    const ua = $.getdata(KEY_UA) || "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1";

    if (!rawCookie) {
        $.msg("HDHive", "âŒ æ— æ³•ç­¾åˆ°", "æ— å‡­è¯ï¼Œè¯·è®¿é—® hdhive.online æˆ– hdhive.com");
        return;
    }

    // --- æ ¸å¿ƒå¤åˆ»ï¼šä» Cookie å­—ç¬¦ä¸²è§£æå­—æ®µ ---
    const cookieObj = parseCookie(rawCookie);
    const token = cookieObj['token'];
    const csrfToken = cookieObj['csrf_access_token'];

    if (!token) {
        $.msg("HDHive", "âŒ å‡­è¯ä¸å®Œæ•´", "Cookie ä¸­ç¼ºå°‘ token å­—æ®µï¼Œè¯·é‡æ–°ç™»å½•æŠ“å–");
        return;
    }

    // åŠ¨æ€åˆ¤æ–­ API åŸŸå (æ ¹æ® Referer æˆ–é»˜è®¤ online)
    let apiHost = "hdhive.online";
    if (referer.includes("hdhive.com")) {
        apiHost = "hdhive.com";
    }
    const apiUrl = `https://${apiHost}/api/customer/user/checkin`;
    const origin = `https://${apiHost}`;

    // --- æ„é€  Headers (å®Œå…¨ä¸€è‡´) ---
    const headers = {
        'User-Agent': ua,
        'Accept': 'application/json, text/plain, */*',
        'Origin': origin,
        'Referer': referer,
        'Authorization': `Bearer ${token}` // Python: f'Bearer {token}'
    };

    // Python: if csrf_token: headers['x-csrf-token'] = csrf_token
    if (csrfToken) {
        headers['x-csrf-token'] = csrfToken;
    }

    // Python: cookies=cookies (è™½ç„¶æ„é€ äº† Authï¼Œä½† Python requests è¿˜æ˜¯å¸¦ä¸Šäº† cookie)
    // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬æŠŠ Cookie ä¹Ÿå¸¦ä¸Š
    headers['Cookie'] = rawCookie;

    const req = {
        url: apiUrl,
        method: "POST",
        headers: headers,
        body: "" // ç©º Body
    };

    return new Promise(resolve => {
        $.post(req, (err, resp, data) => {
            if (err) {
                $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "è¯·æ±‚å¤±è´¥");
                resolve();
                return;
            }

            let resJson = {};
            try { resJson = JSON.parse(data); } catch (e) {}
            
            console.log(`[HDHive] çŠ¶æ€ç : ${resp.status}`);

            // Python é€»è¾‘: if signin_result.get('success') ...
            if (resp.status === 200 || resp.status === 201) {
                const msg = resJson.message || "ç­¾åˆ°æˆåŠŸ";
                $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
            } 
            // Python é€»è¾‘: if "å·²ç»ç­¾åˆ°" in message ...
            else if (resp.status === 400) {
                const msg = resJson.message || "è¯·æ±‚è¢«æ‹’ç»";
                if (msg.includes("å·²ç­¾åˆ°") || msg.includes("ç­¾åˆ°è¿‡") || msg.includes("checked in")) {
                    $.msg("HDHive", "ğŸŸ¢ ä»Šæ—¥å·²ç­¾åˆ°", msg);
                } else {
                    $.msg("HDHive", "âš ï¸ ç­¾åˆ°ç»“æœ(400)", msg);
                }
            } 
            else if (resp.status === 401 || resp.status === 403) {
                 $.msg("HDHive", "âš ï¸ å‡­è¯å¤±æ•ˆ", "Token å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            }
            else {
                $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", `çŠ¶æ€ç  ${resp.status}`);
            }
            resolve();
        });
    });
}

// ------------------------------------------
// è¾…åŠ©å‡½æ•°
// ------------------------------------------

// è§£æ Cookie å­—ç¬¦ä¸²ä¸ºå¯¹è±¡
function parseCookie(cookieStr) {
    const cookies = {};
    if (!cookieStr) return cookies;
    cookieStr.split(';').forEach(item => {
        const parts = item.split('=');
        if (parts.length >= 2) {
            const key = parts[0].trim();
            const value = parts.slice(1).join('=').trim();
            cookies[key] = value;
        }
    });
    return cookies;
}

function getHeader(headers, key) {
    if (!headers) return null;
    const lowerKey = key.toLowerCase();
    for (const k in headers) {
        if (k.toLowerCase() === lowerKey) return headers[k];
    }
    return null;
}

function Env(name) {
    return {
        name: name,
        getdata: (k) => typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null,
        setdata: (v, k) => typeof $persistentStore !== "undefined" ? $persistentStore.write(v, k) : null,
        msg: (t, s, b) => {
            if (typeof $notification !== "undefined") $notification.post(t, s, b);
            console.log(`===${t}===\n${s}\n${b}`);
        },
        post: (o, c) => typeof $httpClient !== "undefined" ? $httpClient.post(o, c) : null,
        logErr: (e) => console.log(`â—ï¸${name} Error: ${e}`),
        done: () => typeof $done !== "undefined" ? $done({}) : null
    };
}
