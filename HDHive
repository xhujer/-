#!name=HDHive è‡ªåŠ¨ç­¾åˆ°
#!desc=åˆäºŒä¸ºä¸€ä¿®å¤ç‰ˆï¼šä»£ç å·²é€šè¿‡å¤šè¡Œè¯­æ³•å†…åµŒï¼Œè§£å†³æ˜¾ç¤ºä¸ºç©ºçš„é—®é¢˜ã€‚
#!author=ming & Gemini
#!icon=https://hdhive.com/favicon.ico
#!homepage=https://hdhive.com/

[Argument]
Cron = input,"0 9 * * *",tag=ç­¾åˆ°æ—¶é—´,desc=Cronè¡¨è¾¾å¼ï¼Œé»˜è®¤æ¯å¤©ä¸Šåˆ9ç‚¹

[Script]
# 1. æŠ“å–å‡­è¯ (è®¿é—®ç½‘é¡µæ—¶è§¦å‘)
http-request ^https?:\/\/hdhive\.com\/api\/ script-path=HDHiveCore, tag=HDHiveè·æƒ, timeout=10, enable=true

# 2. å®šæ—¶ç­¾åˆ° (åå°è‡ªåŠ¨è¿è¡Œ)
cron {Cron} script-path=HDHiveCore, tag=HDHiveç­¾åˆ°, timeout=60

[Mitm]
hostname = hdhive.com

# ==============================================
# æ ¸å¿ƒé€»è¾‘ (ä½¿ç”¨ <<< åŒ…è£¹ï¼ŒLoon å¯æ­£ç¡®è¯†åˆ«)
# ==============================================

[InlineScript]
HDHiveCore = <<<
/**
 * HDHive è‡ªåŠ¨ç­¾åˆ° (Inline)
 */
const $ = new Env("HDHive");

const API_CHECKIN = 'https://hdhive.com/api/customer/user/checkin';
const KEY_TOKEN = 'hdhive_token';
const KEY_CSRF = 'hdhive_csrf';

(async () => {
    if (typeof $request !== "undefined") {
        // --- æ¨¡å¼ 1: æŠ“å– Token ---
        await captureToken();
    } else {
        // --- æ¨¡å¼ 2: æ‰§è¡Œç­¾åˆ° ---
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

async function captureToken() {
    if ($request.url.indexOf("checkin") > -1) return;
    const h = $request.headers;
    const t = h['Authorization'] || h['authorization'];
    const c = h['x-csrf-token'] || h['X-Csrf-Token'];

    if (t && c) {
        const oldT = $.getdata(KEY_TOKEN);
        if (t !== oldT) {
            $.setdata(t, KEY_TOKEN);
            $.setdata(c, KEY_CSRF);
            $.msg("HDHive", "ğŸ‰ å‡­è¯å·²è‡ªåŠ¨æ›´æ–°", "æ— éœ€æ“ä½œï¼Œå·²ä¿å­˜æ–°Token");
            $.log(`[HDHive] Token updated.`);
        }
    }
}

async function checkIn() {
    const t = $.getdata(KEY_TOKEN);
    const c = $.getdata(KEY_CSRF);

    if (!t || !c) {
        $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", "æœªæ£€æµ‹åˆ°å‡­è¯ï¼Œè¯·å…ˆç”¨æµè§ˆå™¨è®¿é—® hdhive.com");
        return;
    }

    const req = {
        url: API_CHECKIN, headers: {
            "Authorization": t, "x-csrf-token": c,
            "Origin": "https://hdhive.com",
            "Referer": "https://hdhive.com/user/dashboard",
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1"
        }
    };

    $.post(req, (err, resp, data) => {
        if (err) {
            $.msg("HDHive", "âŒ ç½‘ç»œé”™è¯¯", "æ— æ³•è¿æ¥æœåŠ¡å™¨");
        } else if (resp.status === 200 || resp.status === 201) {
            let msg = "ç­¾åˆ°æˆåŠŸ";
            try { msg = JSON.parse(data).message || msg; } catch (e) {}
            $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
            $.log(`[HDHive] Success: ${data}`);
        } else if (resp.status === 401) {
            $.msg("HDHive", "âš ï¸ Token å¤±æ•ˆ", "è¯·é‡æ–°è®¿é—®ç½‘é¡µè·å–");
        } else {
            $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", `çŠ¶æ€ç : ${resp.status}`);
        }
    });
}

// Env helper
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}write(t,e){return this.toObj(t,e)}getdata(t){if(arguments.length)return $persistentStore.read(t)}setdata(t,e){if(arguments.length)return $persistentStore.write(t,e)}post(t,e){const s=t.method?"POST"==t.method.toUpperCase()?$httpClient.post:$httpClient.put:$httpClient.post;if(!e)return new Promise(((e,i)=>{s.call(this,t,((t,s,r)=>{t?i(t):e(s)}))}));s.call(this,t,e)}msg(e=t,s="",r="",i){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}}};if(!this.isMuteLog){let t=["","==============ğŸ“£ç³»ç»Ÿé€šçŸ¥ğŸ“£=============="];t.push(e),s&&t.push(s),r&&t.push(r),console.log(t.join("\n")),this.logs=this.logs.concat(t)}$notification.post(e,s,r,o(i))}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t.stack):this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t)}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`ğŸ””${this.name}, ç»“æŸ! ğŸ•› ${s} ç§’`),this.log(),$done(t)}isLoon(){return"undefined"!=typeof $loon}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}}return new s(t)}
>>>
