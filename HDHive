#!name=HDHive è‡ªåŠ¨ç­¾åˆ°
#!desc=è‡ªåŠ¨æŠ“å– HDHive çš„ Token å’Œ CSRFï¼Œå¹¶æ¯æ—¥å®šæ—¶ç­¾åˆ°ã€‚
#!author=ming & Gemini
#!icon=https://hdhive.com/favicon.ico
#!homepage=https://hdhive.com/

[Argument]
Cron = input,"0 9 * * *",tag=ç­¾åˆ°æ—¶é—´,desc=è®¾ç½®æ¯æ—¥ç­¾åˆ°æ‰§è¡Œçš„æ—¶é—´ (Cron è¡¨è¾¾å¼)

[Rule]
# æ— éœ€é¢å¤– Ruleï¼Œé€šè¿‡ Script æ¨¡å—æ‹¦æˆª

[Script]
# æŠ“å–å‡­è¯ (è®¿é—®ç½‘é¡µæˆ–APPæ—¶è§¦å‘)
http-request ^https?:\/\/hdhive\.com\/api\/ script-path=https://raw.githubusercontent.com/doesnotexist/placeholder.js, tag=HDHiveè·æƒ, script-update-interval=0, debug=false, require-body=false, timeout=10, enable=true

# å®šæ—¶ç­¾åˆ°ä»»åŠ¡
cron {Cron} script-path=https://raw.githubusercontent.com/doesnotexist/placeholder.js, tag=HDHiveç­¾åˆ°, timeout=60

[Mitm]
hostname = hdhive.com

# ä¸‹é¢æ˜¯å†…åµŒè„šæœ¬ï¼ŒLoon ä¼šè‡ªåŠ¨è¯»å–
[Script]
# polyfill for script-path
enable = true

[InlineScript]
/**
 * HDHive è‡ªåŠ¨ç­¾åˆ°è„šæœ¬ for Loon
 */

const $ = new Env("HDHive");

const API_CHECKIN = 'https://hdhive.com/api/customer/user/checkin';
const KEY_TOKEN = 'hdhive_token';
const KEY_CSRF = 'hdhive_csrf';

// ------------------------------------
// ä¸»é€»è¾‘
// ------------------------------------

(async () => {
    if (typeof $request !== "undefined") {
        // --- æ¨¡å¼ 1: æŠ“å– Token (HTTP Request) ---
        await captureToken();
    } else {
        // --- æ¨¡å¼ 2: æ‰§è¡Œç­¾åˆ° (Cron) ---
        await checkIn();
    }
})().catch((e) => $.logErr(e)).finally(() => $.done());

// ------------------------------------
// åŠŸèƒ½å‡½æ•°
// ------------------------------------

// 1. æŠ“å–å‡­è¯
async function captureToken() {
    // å¿½ç•¥ç‰¹å®šçš„è¯·æ±‚ä»¥å…æ­»å¾ªç¯ï¼ˆè™½ç„¶æ­£åˆ™å·²ç»é™åˆ¶äº†ï¼‰
    if ($request.url.indexOf("checkin") > -1) return;

    const headers = $request.headers;
    // Loon çš„ headers key å¯èƒ½æ˜¯å°å†™ä¹Ÿå¯èƒ½æ˜¯å¤§å†™ï¼Œç»Ÿä¸€å¤„ç†
    const auth = headers['Authorization'] || headers['authorization'];
    const csrf = headers['x-csrf-token'] || headers['X-Csrf-Token'];

    if (auth && csrf) {
        // è¯»å–æ—§æ•°æ®ç”¨äºå¯¹æ¯”
        const oldAuth = $.getdata(KEY_TOKEN);
        const oldCsrf = $.getdata(KEY_CSRF);

        if (auth !== oldAuth || csrf !== oldCsrf) {
            $.setdata(auth, KEY_TOKEN);
            $.setdata(csrf, KEY_CSRF);
            
            $.msg("HDHive", "ğŸ‰ å‡­è¯è·å–æˆåŠŸ", "Token å’Œ CSRF å·²è‡ªåŠ¨æ›´æ–°");
            $.log(`[HDHive] è·å–æ–°å‡­è¯:\nToken: ${auth}\nCSRF: ${csrf}`);
        }
    }
}

// 2. æ‰§è¡Œç­¾åˆ°
async function checkIn() {
    const token = $.getdata(KEY_TOKEN);
    const csrf = $.getdata(KEY_CSRF);

    if (!token || !csrf) {
        $.msg("HDHive", "âŒ ç­¾åˆ°å¤±è´¥", "æœªæ‰¾åˆ° Tokenï¼Œè¯·å…ˆåœ¨æµè§ˆå™¨è®¿é—® hdhive.com");
        return;
    }

    const req = {
        url: API_CHECKIN,
        method: "POST",
        headers: {
            "Authorization": token,
            "x-csrf-token": csrf,
            "Origin": "https://hdhive.com",
            "Referer": "https://hdhive.com/user/dashboard",
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1",
            "Accept": "application/json, text/plain, */*"
        }
    };

    $.post(req, (err, resp, data) => {
        if (err) {
            $.msg("HDHive", "âŒ ç­¾åˆ°å¼‚å¸¸", "ç½‘ç»œè¯·æ±‚å‡ºé”™");
            $.logErr(err);
            return;
        }

        try {
            // æ ¹æ®åŸè„šæœ¬é€»è¾‘ï¼Œåªè¦èƒ½ parse JSON å°±ç®—æˆåŠŸï¼Œæˆ–è€…åˆ¤æ–­çŠ¶æ€ç 
            if (resp.status === 200 || resp.status === 201) {
                const result = JSON.parse(data);
                // å‡è®¾è¿”å›çš„æ•°æ®é‡Œæœ‰ message å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé€šç”¨æˆåŠŸ
                const msg = result.message || "ç­¾åˆ°æˆåŠŸ";
                $.msg("HDHive", "âœ… ç­¾åˆ°æˆåŠŸ", msg);
                $.log(`[HDHive] ç­¾åˆ°å“åº”: ${data}`);
            } else {
                $.msg("HDHive", "âš ï¸ ç­¾åˆ°å¤±è´¥", `çŠ¶æ€ç : ${resp.status}`);
                $.log(`[HDHive] å¤±è´¥å“åº”: ${data}`);
                
                if (resp.status === 401) {
                     $.msg("HDHive", "âš ï¸ Token å¤±æ•ˆ", "è¯·é‡æ–°è®¿é—®ç½‘ç«™è·å– Token");
                }
            }
        } catch (e) {
            $.msg("HDHive", "âŒ ç­¾åˆ°é”™è¯¯", "è¿”å›æ•°æ®è§£æå¤±è´¥ (å¯èƒ½ Token è¿‡æœŸ)");
            $.log(`[HDHive] è§£æå¤±è´¥: ${data}`);
        }
    });
}

// ------------------------------------
// ç¯å¢ƒå…¼å®¹å±‚ (ç”± chavyleung ç­‰å¤§ä½¬æä¾›æ€è·¯)
// ------------------------------------
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}write(t,e){return this.toObj(t,e)}getdata(t){if(arguments.length)return $persistentStore.read(t)}setdata(t,e){if(arguments.length)return $persistentStore.write(t,e)}post(t,e){const s=t.method?"POST"==t.method.toUpperCase()?$httpClient.post:$httpClient.put:$httpClient.post;if(!e)return new Promise(((e,i)=>{s.call(this,t,((t,s,r)=>{t?i(t):e(s)}))}));s.call(this,t,e)}msg(e=t,s="",r="",i){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,r,o(i)):this.isQuanX()&&$notify(e,s,r,o(i))),!this.isMuteLog){let t=["","==============ğŸ“£ç³»ç»Ÿé€šçŸ¥ğŸ“£=============="];t.push(e),s&&t.push(s),r&&t.push(r),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t.stack):this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t)}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`ğŸ””${this.name}, ç»“æŸ! ğŸ•› ${s} ç§’`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}isLoon(){return"undefined"!=typeof $loon}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}}return new s(t)}
